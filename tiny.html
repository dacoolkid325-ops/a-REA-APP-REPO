<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiny Dash: The Full Experience</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lexend+Exa:wght@700&display=swap');
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Lexend Exa', sans-serif; color: white; user-select: none; }
        canvas { display: block; }
        #ui { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; }
        .panel { background: rgba(0,0,0,0.8); padding: 40px; border-radius: 20px; border: 4px solid #fff; text-align: center; pointer-events: auto; cursor: pointer; }
        h1 { font-size: 50px; margin: 0 0 20px 0; text-shadow: 4px 4px #00f; }
        .btn { background: #0f0; color: #000; padding: 15px 40px; font-size: 24px; border-radius: 10px; display: inline-block; transition: 0.2s; }
        .btn:hover { transform: scale(1.1); }
        #loading { position: absolute; inset: 0; background: #111; display: flex; align-items: center; justify-content: center; font-size: 24px; z-index: 100; }
    </style>
</head>
<body>

    <div id="loading">LOADING ASSETS...</div>

    <div id="ui">
        <div id="menu" class="panel">
            <h1>TINY DASH</h1>
            <div class="btn">PLAY</div>
            <p style="margin-top:20px; font-size: 14px; opacity: 0.7;">SPACE / CLICK TO JUMP & FLY</p>
        </div>
        <div id="death" class="panel" style="display:none; border-color: #f00;">
            <h1 style="color:#f00; text-shadow: 4px 4px #500;">CRASHED</h1>
            <div class="btn" style="background: #f00; color: #fff;">RETRY</div>
        </div>
    </div>

    <canvas id="cvs"></canvas>

<script>
const canvas = document.getElementById('cvs');
const ctx = canvas.getContext('2d');
const menu = document.getElementById('menu');
const death = document.getElementById('death');
const loading = document.getElementById('loading');

// --- Assets ---
const img = new Image();
img.src = "https://www.dropbox.com/scl/fi/achgz4b20pbp4t5kfzuts/IMG_0963.png?rlkey=zc14q2o3gw3epn8fibxgsutpj&st=tm9833na&raw=1";

const menuMusic = new Audio("https://gdcolon.com/assets/audio/menuLoop.mp3");
menuMusic.loop = true;

const gameMusic = new Audio("https://uce2e02b3d17bc677c487dae66e2.dl.dropboxusercontent.com/cd/0/inline/C51w5BdUrUlDgP1gYjJGHxW8BV6nzJy4qvmE198rfxvtKO-t2XIJINGHGwwkDlcFrUzu6ISJ3toiDduxk1mZlC0Dgyi0b-ueON4JXDNWCgH3pWjDUtU4yazKm4vo04E5yxS6ogaKoKZslItAeYWaaf6U/file#");
gameMusic.loop = false;

let loaded = 0;
const checkLoaded = () => {
    loaded++;
    if(loaded >= 1) loading.style.display = 'none';
};
img.onload = checkLoaded;

// --- Constants ---
const GRAVITY = 0.8;
const JUMP = -12;
const SHIP_THRUST = -0.7;
const SPEED = 8;
const TILE = 60;

// --- State ---
let mode = 'MENU';
let player = { x: 200, y: 0, vy: 0, angle: 0, isShip: false, w: 50, h: 50 };
let camX = 0;
let level = [];

// Level Generator (Fixed spacing)
function initLevel() {
    const m = [];
    for(let i=0; i<15; i++) m.push(0); // Start safe
    // Cube section
    m.push(1,0,0,2,0,0,1,1,0,0,2,2,0,0,1,2,1,0,0);
    // Ship transition trigger (using type 3 as ship portal)
    m.push(3,0,0,0); 
    // Ship section (Floating obstacles)
    for(let i=0; i<20; i++) {
        m.push(Math.random() > 0.7 ? 4 : 0); // 4 = Top/Bottom Spikes
    }
    // Cube transition back
    m.push(3,0,0,1,0,2,0,1,2,1,0,0,9);
    return m;
}

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.onresize = resize;
resize();

// --- Input ---
let isPressing = false;
const handleInput = (down) => {
    if(down && (mode === 'MENU' || mode === 'DEAD')) {
        start();
    }
    isPressing = down;
};
window.onmousedown = () => handleInput(true);
window.onmouseup = () => handleInput(false);
window.onkeydown = (e) => { if(e.code === 'Space') handleInput(true); };
window.onkeyup = (e) => { if(e.code === 'Space') handleInput(false); };

function start() {
    mode = 'PLAYING';
    menu.style.display = 'none';
    death.style.display = 'none';
    player.y = canvas.height - 150;
    player.vy = 0;
    player.isShip = false;
    camX = 0;
    level = initLevel();
    menuMusic.pause();
    gameMusic.currentTime = 0;
    gameMusic.play();
}

function update() {
    if(mode !== 'PLAYING') return;

    camX += SPEED;
    let floor = canvas.height - 100;

    if(!player.isShip) {
        // Cube Physics
        player.vy += GRAVITY;
        player.y += player.vy;
        if(isPressing && player.y >= floor - player.h) player.vy = JUMP;
        
        if(player.y < floor - player.h) player.angle += 0.15;
        else {
            player.y = floor - player.h;
            player.vy = 0;
            player.angle = Math.round(player.angle/(Math.PI/2))*(Math.PI/2);
        }
    } else {
        // Ship Physics
        player.vy += isPressing ? SHIP_THRUST : GRAVITY * 0.6;
        player.y += player.vy;
        player.angle = player.vy * 0.05;
        // Ceiling/Floor bounds
        if(player.y < 50 || player.y > floor - player.h) die();
    }

    // Collision
    let curIdx = Math.floor(camX / TILE);
    for(let i = curIdx; i < curIdx + 5; i++) {
        if(!level[i]) continue;
        let tx = i * TILE - camX + 200;
        let ty = floor - TILE;

        if(level[i] === 1 && checkRect(player.x, player.y, player.w, player.h, tx, ty, TILE, TILE)) {
            if(player.vy > 0 && player.y + player.h < ty + 20) {
                player.y = ty - player.h;
                player.vy = 0;
            } else die();
        }
        if(level[i] === 2 && checkRect(player.x+10, player.y+10, player.w-20, player.h-20, tx+15, ty+15, TILE-30, TILE-15)) die();
        if(level[i] === 3 && checkRect(player.x, player.y, player.w, player.h, tx, 0, TILE, canvas.height)) {
            player.isShip = !player.isShip;
            level[i] = 0; // Trigger once
        }
        if(level[i] === 4) { // Ship obstacles
            if(checkRect(player.x, player.y, player.w, player.h, tx, floor - 250, 40, 40)) die();
            if(checkRect(player.x, player.y, player.w, player.h, tx, floor - 450, 40, 40)) die();
        }
    }
}

function checkRect(x1,y1,w1,h1,x2,y2,w2,h2) {
    return x1 < x2 + w2 && x1 + w1 > x2 && y1 < y2 + h2 && y1 + h1 > y2;
}

function die() {
    mode = 'DEAD';
    gameMusic.pause();
    death.style.display = 'block';
    menuMusic.play();
}

function draw() {
    ctx.fillStyle = player.isShip ? '#100' : '#001';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Grid
    ctx.strokeStyle = '#fff1';
    for(let i=0; i<canvas.width; i+=TILE) {
        ctx.beginPath(); ctx.moveTo(i - (camX%TILE), 0); ctx.lineTo(i - (camX%TILE), canvas.height); ctx.stroke();
    }

    let floor = canvas.height - 100;
    ctx.fillStyle = '#000';
    ctx.fillRect(0, floor, canvas.width, 100);
    ctx.strokeStyle = '#0ff';
    ctx.strokeRect(-10, floor, canvas.width+20, 100);

    // Level
    for(let i=0; i<level.length; i++) {
        let tx = i * TILE - camX + 200;
        if(tx < -TILE || tx > canvas.width) continue;
        
        if(level[i] === 1) { // Block
            ctx.fillStyle = '#000'; ctx.strokeStyle = '#fff';
            ctx.fillRect(tx, floor - TILE, TILE, TILE);
            ctx.strokeRect(tx, floor - TILE, TILE, TILE);
        }
        if(level[i] === 2) { // Spike
            ctx.fillStyle = '#f00';
            ctx.beginPath(); ctx.moveTo(tx, floor); ctx.lineTo(tx+TILE/2, floor-TILE); ctx.lineTo(tx+TILE, floor); ctx.fill();
        }
        if(level[i] === 3) { // Portal
            ctx.fillStyle = '#f0f'; ctx.fillRect(tx, 0, 20, canvas.height);
        }
        if(level[i] === 4) { // Ship Spikes
            ctx.fillStyle = '#fff';
            ctx.fillRect(tx, floor - 250, 40, 40);
            ctx.fillRect(tx, floor - 450, 40, 40);
        }
    }

    // Player
    ctx.save();
    ctx.translate(player.x + player.w/2, player.y + player.h/2);
    ctx.rotate(player.angle);
    ctx.drawImage(img, -player.w/2, -player.h/2, player.w, player.h);
    if(player.isShip) {
        ctx.strokeStyle = '#f0f'; ctx.lineWidth = 3;
        ctx.strokeRect(-player.w/2 - 5, -player.h/2 - 5, player.w + 10, player.h + 10);
    }
    ctx.restore();
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}

// Initial Menu Audio trigger
window.addEventListener('click', () => {
    if(menuMusic.paused && mode === 'MENU') menuMusic.play();
}, {once: true});

loop();
</script>
</body>
</html>
