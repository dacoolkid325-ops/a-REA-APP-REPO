<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Find Tiny's Family - PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; overflow: hidden; background: #87CEEB; font-family: 'Fredoka', sans-serif; touch-action: none; user-select: none; }
        canvas { display: block; width: 100vw; height: 100vh; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

        #main-menu {
            position: absolute; inset: 0;
            background: linear-gradient(160deg,#0d1b2a 0%,#1a3a5c 60%,#2e6e9c 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            pointer-events: auto; transition: opacity .5s; z-index: 100;
        }
        h1 { color:#fff; font-size:3.4rem; text-align:center; margin-bottom:10px; line-height:1.1;
             text-shadow:0 0 30px #FFD700,3px 3px 0 #FF8C00; }
        .menu-box {
            background:rgba(255,255,255,.95); padding:28px; border-radius:20px;
            box-shadow:0 20px 40px rgba(0,0,0,.6); text-align:center;
            width:88%; max-width:430px; border:4px solid #FFD700;
        }
        .menu-box input, .menu-box select {
            padding:12px; font-size:1.1rem; border-radius:12px; border:3px solid #ddd;
            margin-bottom:12px; width:calc(100% - 30px); font-family:'Fredoka',sans-serif; outline:none;
        }
        .menu-box input[type="color"]{ padding:5px; height:48px; cursor:pointer; }
        .menu-box button {
            background:#32CD32; color:#fff; border:none; padding:14px; font-size:1.35rem;
            border-radius:12px; cursor:pointer; box-shadow:0 6px 0 #228B22; font-weight:bold;
            width:100%; font-family:'Fredoka',sans-serif; transition:transform .1s; margin-bottom:10px;
        }
        .menu-box button:active { transform:translateY(5px); box-shadow:0 1px 0 #228B22; }
        .btn-secondary{ background:#FF8C00; box-shadow:0 6px 0 #CD853F; }
        .btn-key      { background:#6A0DAD; box-shadow:0 6px 0 #3d0080; }

        #key-modal {
            position:absolute; inset:0; background:rgba(0,0,0,.78);
            display:none; align-items:center; justify-content:center; z-index:300; pointer-events:auto;
        }
        .km-box {
            background:#1a1a2e; border:4px solid #6A0DAD; border-radius:20px;
            padding:30px; text-align:center; width:90%; max-width:360px;
        }
        .km-box h2 { color:#FFD700; margin-bottom:10px; font-size:1.8rem; }
        #key-input {
            font-size:2.2rem; letter-spacing:.5rem; padding:12px; border-radius:12px;
            border:3px solid #6A0DAD; width:100%; text-align:center;
            font-family:'Fredoka',sans-serif; background:#0d0d1a; color:#fff;
            margin-bottom:14px; outline:none;
        }
        .km-btn {
            background:#6A0DAD; color:#fff; border:none; padding:12px 26px;
            font-size:1.15rem; border-radius:12px; cursor:pointer; font-family:'Fredoka',sans-serif;
            margin:4px; font-weight:bold;
        }
        .km-cancel { background:#444; }
        #key-status { font-size:1rem; min-height:24px; margin-top:8px; font-weight:bold; }

        .top-btn {
            background:rgba(255,255,255,.9); border:3px solid #ccc; font-size:.92rem;
            cursor:pointer; border-radius:10px; pointer-events:auto; z-index:101;
            padding:7px 11px; margin-left:5px; font-weight:bold; font-family:'Fredoka',sans-serif;
        }
        #top-right-controls { position:absolute; top:15px; right:15px; display:flex; align-items:center; }
        #hud { position:absolute; top:15px; left:15px; display:none; pointer-events:auto; }
        .tag { padding:6px 14px; border-radius:10px; font-weight:bold; margin-bottom:5px;
               color:#fff; text-shadow:1px 1px 2px #000; font-size:1rem; }
        #room-tag  { background:rgba(65,105,225,.85); border:2px solid #00008B; }
        #timer-tag { background:rgba(20,20,20,.8); border:2px solid #555; }
        #mode-tag  { background:rgba(106,13,173,.9); border:2px solid #FFD700; display:none; }
        .counter-grid {
            display:grid; grid-template-columns:1fr 1fr; gap:5px;
            background:rgba(0,0,0,.65); padding:10px; border-radius:10px; border:2px solid #fff;
        }
        .c-item { font-size:.9rem; }
        .c-tiny  { color:#FFD700; font-weight:900; }

        #dev-panel {
            position:absolute; top:15px; left:50%; transform:translateX(-50%);
            background:rgba(0,0,0,.82); border:2px solid #00FF00; border-radius:10px;
            color:#00FF00; font-family:monospace; font-size:.72rem; padding:8px 14px;
            display:none; pointer-events:none; line-height:1.7; z-index:150; white-space:pre;
        }

        .floating-name {
            position:absolute; color:#fff; background:rgba(0,0,0,.65);
            padding:3px 10px; border-radius:8px; font-size:13px; font-weight:bold;
            transform:translate(-50%,-100%); pointer-events:none; display:none; text-shadow:1px 1px 0 #000;
        }
        .dev-badge   { background:rgba(0,180,0,.85) !important; }
        .admin-badge { background:rgba(150,0,210,.85) !important; }

        #dialogue-box {
            position:absolute; bottom:30px; left:50%; transform:translateX(-50%);
            width:88%; max-width:620px; background:rgba(255,255,255,.97);
            border:5px solid #4169E1; border-radius:20px; padding:16px;
            display:none; box-shadow:0 10px 30px rgba(0,0,0,.5);
            align-items:center; gap:15px; z-index:102; pointer-events:auto;
        }
        .dialogue-img { width:75px; height:75px; border-radius:12px; border:3px solid #4169E1;
                        object-fit:cover; flex-shrink:0; background:#eee; }
        .dialogue-text { font-size:1.1rem; font-weight:bold; color:#333; flex-grow:1; line-height:1.4; }

        #unlock-banner {
            position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
            background:rgba(255,215,0,.97); border:5px solid #FF8C00; border-radius:20px;
            padding:20px 30px; font-size:1.4rem; font-weight:bold; color:#333;
            display:none; z-index:200; text-align:center;
            box-shadow:0 10px 30px rgba(0,0,0,.5); pointer-events:none;
        }
        #unlock-banner img { width:90px; height:90px; border-radius:12px; display:block; margin:10px auto; }
        #locked-msg {
            position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
            background:rgba(0,0,0,.88); border:4px solid #FF4444; border-radius:18px;
            padding:20px 28px; font-size:1.2rem; font-weight:bold; color:#fff;
            display:none; z-index:200; text-align:center; pointer-events:none;
        }
        #toast {
            position:absolute; top:80px; left:50%; transform:translateX(-50%);
            background:rgba(0,0,0,.82); color:#fff; border-radius:12px;
            padding:10px 22px; font-size:1rem; font-weight:bold;
            display:none; z-index:250; pointer-events:none; text-align:center; white-space:nowrap;
        }

        #skin-selector {
            position:absolute; bottom:175px; left:50%; transform:translateX(-50%);
            z-index:103; pointer-events:auto;
            background:rgba(0,0,0,.78); border-radius:14px; padding:8px 12px;
            gap:7px; align-items:center; flex-wrap:wrap; justify-content:center;
            display:none;
        }
        .skin-label { color:#fff; font-weight:bold; font-size:.88rem; width:100%; text-align:center; margin-bottom:4px; }
        #skin-selector button {
            width:auto; padding:6px 13px; font-size:.88rem; margin-bottom:0;
            background:#4169E1; box-shadow:0 3px 0 #00008B; border:none;
            color:#fff; border-radius:8px; cursor:pointer; font-family:'Fredoka',sans-serif; font-weight:bold;
        }
        #skin-selector button.active-skin { background:#FFD700; color:#333; box-shadow:0 3px 0 #CD853F; }
        #skin-selector button.dev-skin    { background:#008800; box-shadow:0 3px 0 #004400; }
        #skin-selector button.admin-skin  { background:#8800BB; box-shadow:0 3px 0 #440066; }

        #joystick-zone {
            position:absolute; bottom:30px; left:30px; width:130px; height:130px;
            background:rgba(255,255,255,.2); border:4px solid rgba(255,255,255,.5);
            border-radius:50%; pointer-events:auto; display:none; touch-action:none;
        }
        #joystick-knob {
            position:absolute; top:30px; left:30px; width:70px; height:70px;
            background:rgba(255,255,255,.85); border-radius:50%; box-shadow:0 5px 10px rgba(0,0,0,.3);
        }
        #jump-btn {
            position:absolute; bottom:40px; right:40px; width:85px; height:85px;
            background:rgba(255,255,255,.3); border:4px solid rgba(255,255,255,.8);
            border-radius:50%; pointer-events:auto; display:none;
            font-size:1.1rem; font-weight:bold; color:#fff; text-shadow:1px 1px 2px #000;
        }
        #cam-hint {
            position:absolute; bottom:180px; right:15px;
            background:rgba(0,0,0,.62); color:#fff; border-radius:10px;
            padding:8px 13px; font-size:.78rem; line-height:1.6; display:none; pointer-events:none;
        }
    </style>
</head>
<body>
<div id="ui-layer">
    <div id="name-label" class="floating-name">Player</div>
    <div id="peer-labels-container"></div>

    <div id="top-right-controls">
        <button id="mic-btn" class="top-btn" onclick="toggleMic()" style="display:none;">ð¤ Off</button>
        <select id="map-select" class="top-btn" onchange="tryTeleportMap(this.value)">
            <option value="1">ð  Home</option>
            <option value="2">ðï¸ Beach</option>
            <option value="3">ð Tiny's Hideout</option>
        </select>
    </div>

    <div id="hud">
        <div id="room-tag" class="tag">Connecting...</div>
        <div id="timer-tag" class="tag">â± 00:00</div>
        <div id="mode-tag" class="tag">Mode</div>
        <div class="tag counter-grid">
            <div class="c-item" id="count-dad">Dad: 0/1</div>
            <div class="c-item" id="count-mum">Mum: 0/1</div>
            <div class="c-item" id="count-bro">Bros: 0/8</div>
            <div class="c-item" id="count-sis">Sis: 0/9</div>
            <div class="c-item c-tiny" id="count-tiny">Tiny: 0/1</div>
        </div>
    </div>

    <div id="dev-panel"></div>

    <div id="main-menu">
        <h1>Find Tiny's<br>Family PRO</h1>
        <div class="menu-box">
            <input type="text" id="player-name" placeholder="Your Name" maxlength="12">
            <label style="display:block;text-align:left;font-weight:bold;margin-bottom:5px;">Skin Colour:</label>
            <input type="color" id="player-color" value="#FF6347">
            <hr style="border:1px solid #eee;margin:14px 0;">
            <input type="text" id="room-code" placeholder="Join Code (leave blank = Host)" maxlength="10">
            <button onclick="startGame()">â¶ ENTER WORLD</button>
            <button class="btn-secondary" id="vc-btn" onclick="enableVoiceChat()">ð¤ Enable Voice Chat</button>
            <button class="btn-key" onclick="openKeyModal()">ð Enter Access Key</button>
            <div id="connection-status" style="margin-top:10px;font-weight:bold;color:#4169E1;">Ready to connect...</div>
        </div>
    </div>

    <div id="key-modal">
        <div class="km-box">
            <h2>ð Access Key</h2>
            <p style="color:#aaa;margin-bottom:14px;font-size:.95rem;">Enter your 6-digit key</p>
            <input type="password" id="key-input" maxlength="6" placeholder="â¢â¢â¢â¢â¢â¢" inputmode="numeric" autocomplete="off">
            <br>
            <button class="km-btn" onclick="submitKey()">â Submit</button>
            <button class="km-btn km-cancel" onclick="closeKeyModal()">â Cancel</button>
            <div id="key-status"></div>
        </div>
    </div>

    <div id="dialogue-box">
        <img id="dialogue-img" src="friend.png"
             onerror="this.onerror=null;this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2270%22 height=%2270%22%3E%3Crect width=%2270%22 height=%2270%22 fill=%22%234169E1%22 rx=%228%22/%3E%3Ctext x=%2235%22 y=%2247%22 font-size=%2232%22 text-anchor=%22middle%22%3E%F0%9F%98%8A%3C/text%3E%3C/svg%3E'"
             class="dialogue-img" alt="Friend">
        <div class="dialogue-text">
            <span style="color:#4169E1;">Friend:</span><br>
            "I've lost Tiny and the whole family! Tiny ALWAYS hides in the hardest spots. Help me find everyone!"
        </div>
        <button onclick="document.getElementById('dialogue-box').style.display='none'"
                style="width:auto;padding:10px 20px;font-size:1rem;">Let's Go! ð</button>
    </div>

    <div id="skin-selector"><span class="skin-label">ð¨ Skin</span></div>

    <div id="unlock-banner"></div>
    <div id="locked-msg"></div>
    <div id="toast"></div>

    <div id="cam-hint">
        ð¥ Camera:<br>
        â â â â Arrow keys<br>
        OR mouse drag<br>
        Scroll = Zoom
    </div>

    <div id="joystick-zone"><div id="joystick-knob"></div></div>
    <button id="jump-btn">JUMP</button>
</div>

<script>
'use strict';

// âââââââââââââââââââââââââââââââââââââââ
// STATE
// âââââââââââââââââââââââââââââââââââââââ
let playerName  = 'Player';
let playerColor = '#FF6347';
let currentMap  = 1;
let secondsElapsed = 0;
let timerInterval  = null;
let gameStarted    = false;
let accessMode     = 'normal'; // 'normal' | 'dev' | 'admin'
let flyMode        = false;
let flyVelY        = 0;

let famTargets    = { dad:1, mum:1, brother:8, sister:9, tiny:1 };
let famFound      = { dad:0, mum:0, brother:0, sister:0, tiny:0 };
let groupUnlocked = { dad:false, mum:false, brother:false, sister:false, tiny:false };

let familyMeshes = [];
let obstacles    = [];
let grassBlades  = [];

let unlockedSkins = ['default'];
let currentSkin   = 'default';

// âââââââââââââââââââââââââââââââââââââââ
// KEY SYSTEM
// âââââââââââââââââââââââââââââââââââââââ
const ACCESS_KEYS = { '212121': 'dev', '221122': 'admin' };

function openKeyModal() {
    document.getElementById('key-input').value = '';
    document.getElementById('key-status').textContent = '';
    document.getElementById('key-modal').style.display = 'flex';
    setTimeout(() => document.getElementById('key-input').focus(), 120);
}
function closeKeyModal() {
    document.getElementById('key-modal').style.display = 'none';
}
document.getElementById('key-input').addEventListener('keydown', e => {
    if(e.key === 'Enter')  submitKey();
    if(e.key === 'Escape') closeKeyModal();
});
function submitKey() {
    const val = document.getElementById('key-input').value.trim();
    const ks  = document.getElementById('key-status');
    const mode = ACCESS_KEYS[val];
    if(mode) {
        accessMode = mode;
        ks.style.color = '#00FF88';
        if(mode === 'dev') {
            ks.textContent = 'â DEV MODE unlocked! ð ï¸';
            if(!unlockedSkins.includes('dev'))   unlockedSkins.push('dev');
        } else if(mode === 'admin') {
            ks.textContent = 'â ADMIN MODE unlocked! ð';
            ['dev','admin','dad','mum','brother','sister','tiny','friend'].forEach(s => {
                if(!unlockedSkins.includes(s)) unlockedSkins.push(s);
            });
        }
        if(gameStarted) {
            buildSkinSelector();
            if(mode === 'admin') adminCollectAll();
            updateModeHUD();
        }
        setTimeout(closeKeyModal, 1600);
    } else {
        ks.style.color = '#FF4444';
        ks.textContent = 'â Invalid key. Try again.';
        document.getElementById('key-input').value = '';
        document.getElementById('key-input').focus();
    }
}
function updateModeHUD() {
    const mt = document.getElementById('mode-tag');
    const dp = document.getElementById('dev-panel');
    if(accessMode === 'dev')   { mt.textContent = 'ð ï¸ DEV MODE';   mt.style.display = 'block'; dp.style.display = 'block'; }
    if(accessMode === 'admin') { mt.textContent = 'ð ADMIN MODE'; mt.style.display = 'block'; }
    const nl = document.getElementById('name-label');
    nl.className = 'floating-name ' + (accessMode==='admin'?'admin-badge':accessMode==='dev'?'dev-badge':'');
}
function adminCollectAll() {
    for(let i = familyMeshes.length-1; i >= 0; i--) {
        const f = familyMeshes[i];
        scene.remove(f.mesh);
        famFound[f.type]++;
        checkGroupUnlock(f.type);
        familyMeshes.splice(i,1);
    }
    updateCounterHUD();
    showToast('ð Admin: all family collected!');
}

// âââââââââââââââââââââââââââââââââââââââ
// VOICE CHAT
// âââââââââââââââââââââââââââââââââââââââ
let peer, peers = {}, localStream = null, micEnabled = false;

async function enableVoiceChat() {
    const btn = document.getElementById('vc-btn');
    btn.disabled = true;
    btn.textContent = 'ð¤ Requesting mic...';
    try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        localStream.getAudioTracks()[0].enabled = false; // start muted
        btn.textContent = 'â Voice Chat Ready';
        btn.style.background = '#228B22';
        btn.style.boxShadow  = '0 6px 0 #145214';
        document.getElementById('mic-btn').style.display = 'block';
        showToast('ð¤ Voice chat enabled â tap Mic to unmute');
    } catch(e) {
        btn.textContent = 'ð¤ Enable Voice Chat';
        btn.disabled = false;
        showToast('â ï¸ Mic denied: ' + (e.message||'check browser permissions'), 3500);
    }
}
function toggleMic() {
    if(!localStream) { showToast('Enable Voice Chat first'); return; }
    micEnabled = !micEnabled;
    localStream.getAudioTracks()[0].enabled = micEnabled;
    document.getElementById('mic-btn').innerText = micEnabled ? 'ð¤ On' : 'ð¤ Off';
}
function initMultiplayer(roomCode) {
    const statusDiv = document.getElementById('connection-status');
    const roomTag   = document.getElementById('room-tag');
    try {
        const myId = roomCode ? null : Math.random().toString(36).substr(2,6).toUpperCase();
        peer = new Peer(myId);
        peer.on('open', id => {
            if(roomCode) {
                statusDiv.textContent = 'Joining lobby...';
                roomTag.textContent   = 'ð Lobby: ' + roomCode;
                connectToPeer(roomCode);
            } else {
                statusDiv.innerHTML = `Host Code:<br><b style="font-size:1.4rem;letter-spacing:.2rem;">${id}</b>`;
                roomTag.textContent = 'ð Host: ' + id;
            }
        });
        peer.on('error', err => { roomTag.textContent = 'â ï¸ Net error'; console.warn('Peer:', err.type); });
        peer.on('connection', conn => handleNewConnection(conn));
        peer.on('call', call => {
            if(localStream) call.answer(localStream);
            call.on('stream', s => playRemoteStream(s));
        });
    } catch(e) { roomTag.textContent = 'ðµ Offline'; }
}
function connectToPeer(id) {
    const conn = peer.connect(id);
    handleNewConnection(conn);
    if(localStream) { const c = peer.call(id, localStream); c.on('stream', s => playRemoteStream(s)); }
}
function handleNewConnection(conn) {
    conn.on('open', () => conn.send({ type:'init', name:playerName, color:playerColor }));
    conn.on('data', data => {
        if(!peers[conn.peer]) createFriendMesh(conn.peer);
        const p = peers[conn.peer];
        if(data.type==='init') { p.mesh.material.color.set(data.color); p.labelDiv.innerText = data.name; p.conn = conn; }
        else if(data.type==='move') {
            p.mesh.position.set(data.x,data.y,data.z);
            p.mesh.lookAt(new THREE.Vector3(camera.position.x, data.y, camera.position.z));
        }
    });
    conn.on('close', () => {
        if(peers[conn.peer]) { scene.remove(peers[conn.peer].mesh); peers[conn.peer].labelDiv.remove(); delete peers[conn.peer]; }
    });
}
function createFriendMesh(id) {
    const mesh = new THREE.Mesh(
        new THREE.PlaneGeometry(2,2.2),
        new THREE.MeshStandardMaterial({ color:0xffffff, side:THREE.DoubleSide })
    );
    mesh.castShadow = true; scene.add(mesh);
    const label = document.createElement('div');
    label.className = 'floating-name'; label.style.display = 'block'; label.innerText = 'Friend';
    document.getElementById('peer-labels-container').appendChild(label);
    peers[id] = { mesh, labelDiv:label, conn:null };
}
function playRemoteStream(stream) {
    const a = document.createElement('audio');
    a.srcObject = stream; a.autoplay = true; a.style.display = 'none'; document.body.appendChild(a);
}

// âââââââââââââââââââââââââââââââââââââââ
// THREE.JS SETUP
// âââââââââââââââââââââââââââââââââââââââ
const scene    = new THREE.Scene();
scene.fog      = new THREE.FogExp2(0xFFF0D0, 0.012);
const camera   = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias:true, powerPreference:'high-performance' });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.shadowMap.enabled = true;
renderer.shadowMap.type    = THREE.PCFSoftShadowMap;
renderer.toneMapping       = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.1;
document.body.insertBefore(renderer.domElement, document.getElementById('ui-layer'));

// LIGHTING
const hemiLight = new THREE.HemisphereLight(0xFFE0A0, 0x4A7A20, 0.85);
scene.add(hemiLight);

const sunLight = new THREE.DirectionalLight(0xFFCC77, 1.5);
sunLight.castShadow = true;
sunLight.shadow.mapSize.width = sunLight.shadow.mapSize.height = 2048;
sunLight.shadow.camera.near = 0.5; sunLight.shadow.camera.far = 500;
sunLight.shadow.camera.left = -120; sunLight.shadow.camera.right = 120;
sunLight.shadow.camera.top  = 120;  sunLight.shadow.camera.bottom = -120;
sunLight.shadow.bias = -0.001;
scene.add(sunLight);

let dayCycle = Math.PI * 0.12; // morning start
sunLight.position.set(Math.cos(dayCycle)*120, Math.sin(dayCycle)*100, 40);

const ambientLight = new THREE.AmbientLight(0xFFD0A0, 0.35);
scene.add(ambientLight);
scene.background = new THREE.Color(0xFFD9A0);

// TERRAIN
const textureLoader   = new THREE.TextureLoader();
const groundMat       = new THREE.MeshStandardMaterial({ color:0x5A9E35, roughness:0.9 });
const beachMat        = new THREE.MeshStandardMaterial({ color:0xF0D090, roughness:0.8 });
const classroomMat    = new THREE.MeshStandardMaterial({ color:0xD4C4A0, roughness:0.7 });
let terrainMesh = null;

textureLoader.load('grass.png', tex => {
    tex.wrapS = tex.wrapT = THREE.RepeatWrapping; tex.repeat.set(50,50);
    groundMat.map = tex; groundMat.needsUpdate = true;
}, undefined, ()=>{});

function buildTerrain(m) {
    if(terrainMesh) { scene.remove(terrainMesh); terrainMesh = null; }
    const mat  = m===1 ? groundMat : m===2 ? beachMat : classroomMat;
    const size = m===3 ? 80 : 400;
    const segs = m===3 ? 4  : 64;
    const geo  = new THREE.PlaneGeometry(size, size, segs, segs);
    geo.rotateX(-Math.PI/2);
    if(m !== 3) {
        const pos = geo.attributes.position;
        for(let i=0;i<pos.count;i++) {
            const x=pos.getX(i), z=pos.getZ(i);
            let y = Math.sin(x*0.05)*Math.cos(z*0.05)*4 + Math.sin(x*0.02)*2;
            if(m===2) y *= 0.25;
            pos.setY(i, y);
        }
        geo.computeVertexNormals();
    }
    terrainMesh = new THREE.Mesh(geo, mat);
    terrainMesh.receiveShadow = true;
    scene.add(terrainMesh);
}

// PLAYER
const playerGeo = new THREE.PlaneGeometry(2, 2.2);
const playerMat = new THREE.MeshStandardMaterial({ color:0xFF6347, side:THREE.DoubleSide, transparent:true });
const player    = new THREE.Mesh(playerGeo, playerMat);
player.castShadow = true;
scene.add(player);
const shadowDisc = new THREE.Mesh(
    new THREE.CircleGeometry(0.7, 14),
    new THREE.MeshBasicMaterial({ color:0x000000, transparent:true, opacity:0.28 })
);
shadowDisc.rotation.x = -Math.PI/2;
scene.add(shadowDisc);

// âââââââââââââââââââââââââââââââââââââââ
// CAMERA â Roblox-style orbit
// âââââââââââââââââââââââââââââââââââââââ
let camYaw   = 0;
let camPitch = 0.45;
let camDist  = 18;
const CAM_SPD = 0.028;

let mouseDrag = false, lastMX = 0, lastMY = 0;
renderer.domElement.addEventListener('mousedown', e => { if(e.button===0){ mouseDrag=true; lastMX=e.clientX; lastMY=e.clientY; } });
renderer.domElement.addEventListener('mousemove', e => {
    if(!mouseDrag) return;
    camYaw  -= (e.clientX-lastMX)*0.004; camPitch -= (e.clientY-lastMY)*0.004;
    camPitch = Math.max(0.08, Math.min(1.45, camPitch));
    lastMX=e.clientX; lastMY=e.clientY;
});
renderer.domElement.addEventListener('mouseup',    ()=>mouseDrag=false);
renderer.domElement.addEventListener('mouseleave', ()=>mouseDrag=false);
renderer.domElement.addEventListener('wheel', e=>{ camDist=Math.max(4,Math.min(55,camDist+e.deltaY*0.05)); },{passive:true});

// Touch camera â right-half swipe
const camTouches = {};
renderer.domElement.addEventListener('touchstart', e=>{
    for(const t of e.changedTouches) if(t.clientX>innerWidth*0.45) camTouches[t.identifier]={x:t.clientX,y:t.clientY};
},{passive:true});
renderer.domElement.addEventListener('touchmove', e=>{
    for(const t of e.changedTouches){
        if(camTouches[t.identifier]){
            const p=camTouches[t.identifier];
            camYaw  -=(t.clientX-p.x)*0.005; camPitch-=(t.clientY-p.y)*0.005;
            camPitch=Math.max(0.08,Math.min(1.45,camPitch));
            camTouches[t.identifier]={x:t.clientX,y:t.clientY}; e.preventDefault();
        }
    }
},{passive:false});
renderer.domElement.addEventListener('touchend', e=>{ for(const t of e.changedTouches) delete camTouches[t.identifier]; },{passive:true});

function updateCamera() {
    camera.position.set(
        player.position.x + Math.sin(camYaw)*camDist*Math.cos(camPitch),
        player.position.y + Math.sin(camPitch)*camDist,
        player.position.z + Math.cos(camYaw)*camDist*Math.cos(camPitch)
    );
    camera.lookAt(player.position.x, player.position.y+1, player.position.z);
}

// RAYCASTER
const groundRay = new THREE.Raycaster();
const downVec   = new THREE.Vector3(0,-1,0);
function getTerrainHeight(x,z) {
    if(!terrainMesh) return 0;
    groundRay.set(new THREE.Vector3(x,200,z), downVec);
    const hits = groundRay.intersectObject(terrainMesh);
    return hits.length ? hits[0].point.y : 0;
}

// âââââââââââââââââââââââââââââââââââââââ
// SKINS
// âââââââââââââââââââââââââââââââââââââââ
const SKIN_IMGS = {
    default:null, dad:'dad.png', mum:'mum.png', brother:'brother.png',
    sister:'sister.png', tiny:'tiny.png', friend:'friend.png', admin:'admin.png', dev:'dev.png',
};
const skinTexCache = {};
function loadSkinTex(name, cb) {
    if(name in skinTexCache) { cb(skinTexCache[name]); return; }
    if(!SKIN_IMGS[name])     { skinTexCache[name]=null; cb(null); return; }
    textureLoader.load(SKIN_IMGS[name], tex=>{ skinTexCache[name]=tex; cb(tex); }, null, ()=>{ skinTexCache[name]=null; cb(null); });
}
function applySkin(name) {
    currentSkin = name;
    loadSkinTex(name, tex => {
        playerMat.map = tex || null;
        playerMat.color.set(tex ? 0xFFFFFF : playerColor);
        playerMat.needsUpdate = true;
    });
    document.querySelectorAll('#skin-selector button').forEach(b =>
        b.classList.toggle('active-skin', b.dataset.skin===name)
    );
}
function buildSkinSelector() {
    const sel = document.getElementById('skin-selector');
    sel.innerHTML = '<span class="skin-label">ð¨ Skin</span>';
    unlockedSkins.forEach(skin => {
        const btn = document.createElement('button');
        btn.dataset.skin = skin;
        btn.textContent  = skin==='default'?'ð¨ Default':skin==='dev'?'ð ï¸ Dev':skin==='admin'?'ð Admin':skin[0].toUpperCase()+skin.slice(1);
        if(skin==='dev')         btn.classList.add('dev-skin');
        else if(skin==='admin')  btn.classList.add('admin-skin');
        if(skin===currentSkin)   btn.classList.add('active-skin');
        btn.onclick = () => applySkin(skin);
        sel.appendChild(btn);
    });
    sel.style.display = 'flex';
}

// âââââââââââââââââââââââââââââââââââââââ
// MAP SYSTEM
// âââââââââââââââââââââââââââââââââââââââ
function tryTeleportMap(level) {
    level = parseInt(level);
    if(level===3 && accessMode==='normal') {
        const nf = famFound.dad+famFound.mum+famFound.brother+famFound.sister;
        const nt = famTargets.dad+famTargets.mum+famTargets.brother+famTargets.sister;
        if(nf < nt) { showLockedMsg("Find everyone else first!\nThen Tiny's Hideout unlocks ð"); document.getElementById('map-select').value=currentMap; return; }
    }
    currentMap = level; loadMapEntities();
}

function loadMapEntities() {
    famFound    = { dad:0, mum:0, brother:0, sister:0, tiny:0 };
    groupUnlocked = { dad:false, mum:false, brother:false, sister:false, tiny:false };
    updateCounterHUD();
    familyMeshes.forEach(f=>scene.remove(f.mesh));
    obstacles.forEach(o=>scene.remove(o.mesh));
    grassBlades.forEach(g=>scene.remove(g));
    scene.children.filter(c=>c.userData.deco).forEach(c=>scene.remove(c));
    familyMeshes=[]; obstacles=[]; grassBlades=[];
    buildTerrain(currentMap);
    updateSceneLighting(currentMap);
    if(currentMap===1)      buildHomeMap();
    else if(currentMap===2) buildBeachMap();
    else                    buildClassroomMap();
    player.position.set(0,10,0);
    flyVelY=0; velocityY=0; isGrounded=false;
    // Admin instant collect
    if(accessMode==='admin') setTimeout(adminCollectAll, 300);
}

function updateSceneLighting(m) {
    if(m===1){ hemiLight.color.set(0xFFE0A0); hemiLight.groundColor.set(0x4A7A20); hemiLight.intensity=0.85; sunLight.color.set(0xFFCC77); sunLight.intensity=1.5; scene.fog.color.set(0xFFF0D0); scene.background=new THREE.Color(0xFFCCA0); ambientLight.color.set(0xFFD0A0); ambientLight.intensity=0.35; }
    else if(m===2){ hemiLight.color.set(0xAADDFF); hemiLight.groundColor.set(0xF0D090); hemiLight.intensity=1.0; sunLight.color.set(0xFFEE88); sunLight.intensity=1.8; scene.fog.color.set(0xBBEEFF); scene.background=new THREE.Color(0x88CCFF); ambientLight.color.set(0xBBDDFF); ambientLight.intensity=0.4; }
    else{ hemiLight.color.set(0xFFEED0); hemiLight.groundColor.set(0x997755); hemiLight.intensity=0.55; sunLight.color.set(0xFFCC88); sunLight.intensity=0.7; scene.fog.color.set(0xEEDDCC); scene.background=new THREE.Color(0xEEDDCC); ambientLight.color.set(0xFFDDAA); ambientLight.intensity=0.5; }
}

function mkMesh(geo, p) { return new THREE.Mesh(geo, new THREE.MeshStandardMaterial(p)); }

// MAP 1
function buildHomeMap() {
    for(let i=0;i<50;i++){
        const s=Math.random()*2+0.8, rx=(Math.random()-.5)*280, rz=(Math.random()-.5)*280;
        const r=mkMesh(new THREE.DodecahedronGeometry(s),{color:0x777777,roughness:0.9});
        r.position.set(rx,getTerrainHeight(rx,rz)+s/2,rz); r.castShadow=r.receiveShadow=true; scene.add(r);
        obstacles.push({mesh:r,radius:s*1.1,x:rx,z:rz});
    }
    for(let i=0;i<28;i++) addTree((Math.random()-.5)*300,(Math.random()-.5)*300);
    addHouse(15,0,15); spawnGrass(200,280); spawnFamily();
}
// MAP 2
function buildBeachMap() {
    const ocean=mkMesh(new THREE.PlaneGeometry(600,250),{color:0x1A9BD0,roughness:0.15,metalness:0.1,transparent:true,opacity:0.82});
    ocean.rotation.x=-Math.PI/2; ocean.position.set(0,-0.8,-220); ocean.userData.deco=true; scene.add(ocean);
    for(let i=0;i<22;i++) addPalmTree((Math.random()-.5)*250,(Math.random()-.5)*200);
    for(let i=0;i<9;i++)  addUmbrella((Math.random()-.5)*160,(Math.random()-.5)*150);
    for(let i=0;i<18;i++){
        const s=Math.random()*1.8+0.4, rx=(Math.random()-.5)*240, rz=(Math.random()-.5)*190;
        const r=mkMesh(new THREE.SphereGeometry(s,5,4),{color:0xD0B080,roughness:1});
        r.position.set(rx,getTerrainHeight(rx,rz)+s/2,rz); r.userData.deco=true; r.castShadow=true; scene.add(r);
        obstacles.push({mesh:r,radius:s*1.2,x:rx,z:rz});
    }
    spawnFamily();
}
// MAP 3
function buildClassroomMap() {
    const wm=new THREE.MeshStandardMaterial({color:0xF5F0E8,roughness:0.9});
    [[0,4,-40,80,8,0.5],[0,4,40,80,8,0.5],[-40,4,0,0.5,8,80],[40,4,0,0.5,8,80]].forEach(([x,y,z,w,h,d])=>{
        const m=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),wm); m.position.set(x,y,z); m.castShadow=m.receiveShadow=true; m.userData.deco=true; scene.add(m);
    });
    const ceil=mkMesh(new THREE.PlaneGeometry(80,80),{color:0xEEEEEE}); ceil.rotation.x=Math.PI/2; ceil.position.y=8; ceil.userData.deco=true; scene.add(ceil);
    const board=mkMesh(new THREE.BoxGeometry(22,6,0.3),{color:0x1A5C2A}); board.position.set(0,5,-38); board.castShadow=true; board.userData.deco=true; scene.add(board);
    for(let i=0;i<4;i++){ const l=mkMesh(new THREE.BoxGeometry(14,0.35,0.1),{color:0xFFFFFF}); l.position.set(-2,7-i*1.2,-37.8); l.userData.deco=true; scene.add(l); }
    for(let row=0;row<3;row++) for(let col=0;col<4;col++) addDesk(-15+col*10,-12+row*10);
    addDesk(0,-28,true);
    for(let i=0;i<3;i++){
        const bulb=mkMesh(new THREE.SphereGeometry(0.3,6,4),{color:0xFFFFCC,emissive:0xFFFFAA,emissiveIntensity:1.3}); bulb.position.set(-15+i*15,7.5,0); bulb.userData.deco=true; scene.add(bulb);
        const pl=new THREE.PointLight(0xFFEEAA,1.7,32); pl.position.set(-15+i*15,7,0); pl.userData.deco=true; scene.add(pl);
    }
    for(const s of[-1,1]){ const win=mkMesh(new THREE.BoxGeometry(8,5,0.4),{color:0xAADDFF,transparent:true,opacity:0.6}); win.position.set(s*40,5,0); win.userData.deco=true; scene.add(win); }
    spawnFamily();
}

function addTree(x,z) {
    const ty=getTerrainHeight(x,z);
    const tr=mkMesh(new THREE.CylinderGeometry(0.3,0.5,4,6),{color:0x7B4F2E}); tr.position.set(x,ty+2,z); tr.castShadow=true; tr.userData.deco=true; scene.add(tr);
    const top=mkMesh(new THREE.SphereGeometry(3,7,6),{color:0x2E8B20,roughness:1}); top.position.set(x,ty+6,z); top.castShadow=true; top.userData.deco=true; scene.add(top);
    obstacles.push({mesh:tr,radius:1.3,x,z});
}
function addHouse(x,y,z) {
    const w=mkMesh(new THREE.BoxGeometry(10,6,10),{color:0xF5E6C8}); w.position.set(x,y+3,z); w.castShadow=w.receiveShadow=true; w.userData.deco=true; scene.add(w);
    const r=mkMesh(new THREE.ConeGeometry(8,4,4),{color:0xC0392B}); r.position.set(x,y+8,z); r.rotation.y=Math.PI/4; r.castShadow=true; r.userData.deco=true; scene.add(r);
    obstacles.push({mesh:w,radius:7,x,z});
}
function addPalmTree(x,z) {
    const ty=getTerrainHeight(x,z);
    const tr=mkMesh(new THREE.CylinderGeometry(0.2,0.4,7,5),{color:0x9B7845}); tr.position.set(x,ty+3.5,z); tr.castShadow=true; tr.userData.deco=true; scene.add(tr);
    const top=mkMesh(new THREE.SphereGeometry(2.8,6,4),{color:0x2EA020}); top.scale.y=0.38; top.position.set(x,ty+8,z); top.userData.deco=true; scene.add(top);
    obstacles.push({mesh:tr,radius:1.1,x,z});
}
function addUmbrella(x,z) {
    const ty=getTerrainHeight(x,z);
    const p=mkMesh(new THREE.CylinderGeometry(0.1,0.1,4,5),{color:0x888888}); p.position.set(x,ty+2,z); p.userData.deco=true; scene.add(p);
    const cols=[0xFF4444,0xFFFF00,0x44AAFF,0xFF8800,0xFF44FF];
    const t=mkMesh(new THREE.ConeGeometry(2.8,1.1,8),{color:cols[Math.floor(Math.random()*cols.length)]}); t.rotation.x=Math.PI; t.position.set(x,ty+5,z); t.userData.deco=true; scene.add(t);
}
function addDesk(x,z,big=false) {
    const s=big?1.5:1;
    const d=mkMesh(new THREE.BoxGeometry(3*s,0.22,2*s),{color:0xC8A060,roughness:0.8}); d.position.set(x,1.5,z); d.castShadow=d.receiveShadow=true; d.userData.deco=true; scene.add(d);
    [[-1,0],[1,0],[-1,0.8],[1,0.8]].forEach(([ox,oz])=>{ const l=mkMesh(new THREE.CylinderGeometry(0.1,0.1,1.5,4),{color:0x8B6535}); l.position.set(x+ox*1.2*s,0.75,z+oz*0.8*s); l.userData.deco=true; scene.add(l); });
    obstacles.push({mesh:d,radius:1.9*s,x,z});
}
function spawnGrass(count,spread) {
    const gm=new THREE.MeshStandardMaterial({color:0x228B22,side:THREE.DoubleSide});
    for(let i=0;i<count;i++){
        const g=new THREE.Mesh(new THREE.PlaneGeometry(1.5,3.5),gm);
        const gx=(Math.random()-.5)*spread, gz=(Math.random()-.5)*spread;
        g.position.set(gx,getTerrainHeight(gx,gz)+1.75,gz); g.rotation.y=Math.random()*Math.PI;
        scene.add(g); grassBlades.push(g);
    }
}

function typeColor(t){ return {dad:0x0000CD,mum:0xFF1493,brother:0x1E90FF,sister:0xFF69B4,tiny:0xFFD700}[t]||0xFFFFFF; }

function spawnFamily() {
    const roster=[{type:'dad',scale:2.2},{type:'mum',scale:2.0}];
    for(let i=0;i<8;i++) roster.push({type:'brother',scale:1.8});
    for(let i=0;i<9;i++) roster.push({type:'sister', scale:1.7});
    if(currentMap===3)   roster.push({type:'tiny',   scale:0.9});
    roster.forEach(mem => {
        const mat=new THREE.MeshStandardMaterial({side:THREE.DoubleSide,transparent:true});
        textureLoader.load(mem.type+'.png', tex=>{mat.map=tex;mat.color.set(0xFFFFFF);mat.needsUpdate=true;}, null, ()=>{mat.color.set(typeColor(mem.type));});
        const mesh=new THREE.Mesh(new THREE.PlaneGeometry(mem.scale,mem.scale*1.25),mat);
        let mx,mz;
        if(currentMap===3){ mx=(Math.random()-.5)*60; mz=(Math.random()-.5)*60; }
        else if(mem.type==='tiny'){ mx=(Math.random()>.5?1:-1)*(110+Math.random()*40); mz=(Math.random()>.5?1:-1)*(110+Math.random()*40); }
        else { mx=(Math.random()-.5)*200; mz=(Math.random()-.5)*200; }
        mesh.position.set(mx,getTerrainHeight(mx,mz)+mem.scale*0.65,mz);
        mesh.castShadow=true; scene.add(mesh);
        familyMeshes.push({mesh,type:mem.type});
    });
}

function updateCounterHUD() {
    document.getElementById('count-dad').innerText  =`Dad: ${famFound.dad}/${famTargets.dad}`;
    document.getElementById('count-mum').innerText  =`Mum: ${famFound.mum}/${famTargets.mum}`;
    document.getElementById('count-bro').innerText  =`Bros: ${famFound.brother}/${famTargets.brother}`;
    document.getElementById('count-sis').innerText  =`Sis: ${famFound.sister}/${famTargets.sister}`;
    document.getElementById('count-tiny').innerText =`Tiny: ${famFound.tiny}/${famTargets.tiny}`;
    const nf=famFound.dad+famFound.mum+famFound.brother+famFound.sister;
    const nt=famTargets.dad+famTargets.mum+famTargets.brother+famTargets.sister;
    if(nf>=nt){ const o=document.querySelector('#map-select option[value="3"]'); if(o&&o.textContent.includes('ð')) o.textContent="ð« Tiny's Hideout"; }
}

// âââââââââââââââââââââââââââââââââââââââ
// CONTROLS
// âââââââââââââââââââââââââââââââââââââââ
// WASD = movement | Arrow keys = camera only (NO movement conflict)
const moveKeys = { w:false, a:false, s:false, d:false };
const camKeys  = { ArrowLeft:false, ArrowRight:false, ArrowUp:false, ArrowDown:false };

window.addEventListener('keydown', e => {
    const k = e.key;
    if(k in moveKeys) moveKeys[k] = true;
    if(k in camKeys)  { camKeys[k]=true; e.preventDefault(); }
    if(k===' ')       doJump();
    if(k==='f'||k==='F') { if(accessMode==='dev'){ flyMode=!flyMode; showToast(flyMode?'ð ï¸ Fly ON  (jump=up)':'ð ï¸ Fly OFF'); } }
    if(k==='r'||k==='R') { if(accessMode==='dev'){ player.position.set(0,10,0); showToast('ð ï¸ Position reset'); } }
    if(k==='g'||k==='G') { if(accessMode==='admin'||accessMode==='dev') adminCollectAll(); }
});
window.addEventListener('keyup', e => {
    const k=e.key;
    if(k in moveKeys) moveKeys[k]=false;
    if(k in camKeys)  camKeys[k]=false;
});

let joyMoveX=0,joyMoveY=0,isTouching=false,joyCenter={x:0,y:0};
let velocityY=0,isGrounded=false;
const GRAVITY=0.022,JUMP_POWER=0.52,SPEED=0.32;

document.getElementById('jump-btn').addEventListener('touchstart',e=>{e.preventDefault();doJump();});
function doJump(){ if(flyMode){flyVelY=0.55;return;} if(isGrounded){velocityY=JUMP_POWER;isGrounded=false;} }

const joyZone=document.getElementById('joystick-zone');
const joyKnob=document.getElementById('joystick-knob');
joyZone.addEventListener('touchstart',e=>{ isTouching=true; const r=joyZone.getBoundingClientRect(); joyCenter={x:r.left+65,y:r.top+65}; updateJoy(e.touches[0]); },{passive:true});
joyZone.addEventListener('touchmove',e=>{if(isTouching){e.preventDefault();updateJoy(e.touches[0]);}},{passive:false});
joyZone.addEventListener('touchend',()=>{isTouching=false;joyMoveX=joyMoveY=0;joyKnob.style.transform='translate(0,0)';});
function updateJoy(t){
    let dx=t.clientX-joyCenter.x,dy=t.clientY-joyCenter.y;
    const d=Math.sqrt(dx*dx+dy*dy),m=38;
    if(d>m){dx=dx/d*m;dy=dy/d*m;}
    joyKnob.style.transform=`translate(${dx}px,${dy}px)`;
    joyMoveX=dx/m; joyMoveY=dy/m;
}

// âââââââââââââââââââââââââââââââââââââââ
// MAIN LOOP
// âââââââââââââââââââââââââââââââââââââââ
function animate() {
    requestAnimationFrame(animate);

    // Day cycle
    dayCycle += 0.00025;
    sunLight.position.set(Math.cos(dayCycle)*120, Math.abs(Math.sin(dayCycle)*100), 40);

    // Camera orbit from arrow keys
    if(camKeys.ArrowLeft)  camYaw   += CAM_SPD;
    if(camKeys.ArrowRight) camYaw   -= CAM_SPD;
    if(camKeys.ArrowUp)    camPitch  = Math.min(1.45, camPitch+CAM_SPD);
    if(camKeys.ArrowDown)  camPitch  = Math.max(0.08, camPitch-CAM_SPD);

    // Movement (WASD, relative to camera)
    let mx=0,mz=0;
    if(isTouching){ mx=joyMoveX*SPEED; mz=joyMoveY*SPEED; }
    else {
        const fwd=new THREE.Vector3(-Math.sin(camYaw),0,-Math.cos(camYaw));
        const rgt=new THREE.Vector3( Math.cos(camYaw),0,-Math.sin(camYaw));
        if(moveKeys.w){mx+=fwd.x*SPEED;mz+=fwd.z*SPEED;}
        if(moveKeys.s){mx-=fwd.x*SPEED;mz-=fwd.z*SPEED;}
        if(moveKeys.a){mx-=rgt.x*SPEED;mz-=rgt.z*SPEED;}
        if(moveKeys.d){mx+=rgt.x*SPEED;mz+=rgt.z*SPEED;}
    }

    // Collision (skip if dev+fly = noclip)
    const nx=player.position.x+mx, nz=player.position.z+mz;
    let hit=false;
    if(!(accessMode==='dev'&&flyMode)) {
        for(const r of obstacles){ if(Math.sqrt((nx-r.x)**2+(nz-r.z)**2)<r.radius+0.9){hit=true;break;} }
    }
    if(!hit){player.position.x=nx;player.position.z=nz;}

    // Physics
    const tH=getTerrainHeight(player.position.x,player.position.z);
    if(flyMode) {
        flyVelY*=0.88; player.position.y+=flyVelY;
        if(player.position.y<tH+1) player.position.y=tH+1;
        isGrounded=false;
    } else {
        if(!isGrounded){ player.position.y+=velocityY; velocityY-=GRAVITY; if(player.position.y<=tH+1){player.position.y=tH+1;isGrounded=true;velocityY=0;} }
        else { player.position.y=tH+1; }
    }
    shadowDisc.position.set(player.position.x,tH+0.04,player.position.z);

    // Billboards face camera (horizontal)
    const cfx=camera.position.x, cfz=camera.position.z;
    player.lookAt(cfx,player.position.y,cfz);
    for(const f of familyMeshes) f.mesh.lookAt(cfx,f.mesh.position.y,cfz);
    for(const id in peers)       peers[id].mesh.lookAt(cfx,peers[id].mesh.position.y,cfz);

    // Grass sway
    const t=performance.now()*0.001;
    grassBlades.forEach((g,i)=>{ g.rotation.z=Math.sin(t*1.3+i)*0.07; });

    updateCamera();
    updateLabel(player, document.getElementById('name-label'));
    for(const id in peers) updateLabel(peers[id].mesh, peers[id].labelDiv);

    // Collection
    for(let i=familyMeshes.length-1;i>=0;i--){
        const fam=familyMeshes[i];
        if(player.position.distanceTo(fam.mesh.position)<2.9){
            scene.remove(fam.mesh); famFound[fam.type]++; familyMeshes.splice(i,1);
            updateCounterHUD(); checkGroupUnlock(fam.type); checkWin();
        }
    }

    // Network
    for(const id in peers){ const p=peers[id]; if(p.conn&&p.conn.open) p.conn.send({type:'move',x:player.position.x,y:player.position.y,z:player.position.z}); }

    // Dev overlay
    if(accessMode==='dev'){
        const pp=player.position;
        document.getElementById('dev-panel').textContent=
            `ð ï¸ DEV  Pos:(${pp.x.toFixed(1)},${pp.y.toFixed(1)},${pp.z.toFixed(1)})  Cam:yaw${(camYaw*57.3).toFixed(0)}Â°,pitch${(camPitch*57.3).toFixed(0)}Â°\n` +
            `Family left:${familyMeshes.length}  Map:${currentMap}  Fly:${flyMode?'ON':'OFF'}  Skin:${currentSkin}\n` +
            `[F] toggle fly  [R] reset pos  [G] collect all  [ââââ] camera`;
    }

    renderer.render(scene,camera);
}

function updateLabel(mesh,el){
    const v=mesh.position.clone(); v.y+=1.9; v.project(camera);
    if(v.z>1){el.style.display='none';return;}
    el.style.left=`${(v.x*.5+.5)*innerWidth}px`; el.style.top=`${(v.y*-.5+.5)*innerHeight}px`; el.style.display='block';
}

function checkGroupUnlock(type){
    if(groupUnlocked[type]) return;
    if(famFound[type]>=famTargets[type]){
        groupUnlocked[type]=true;
        if(!unlockedSkins.includes(type)){ unlockedSkins.push(type); buildSkinSelector(); showUnlockBanner(type); }
    }
}
function checkWin(){
    if(famFound.dad+famFound.mum+famFound.brother+famFound.sister+famFound.tiny>=20)
        setTimeout(()=>alert('ð You found EVERYONE!\n'+document.getElementById('timer-tag').innerText+'\nIncredible!'),300);
}

// UI HELPERS
function showLockedMsg(text){ const el=document.getElementById('locked-msg'); el.innerHTML='ð '+text.replace(/\n/g,'<br>'); el.style.display='block'; clearTimeout(el._t); el._t=setTimeout(()=>el.style.display='none',3200); }
function showUnlockBanner(type){
    const el=document.getElementById('unlock-banner'), src=SKIN_IMGS[type]||'';
    el.innerHTML=`<div style="font-size:2rem;">ð UNLOCKED!</div>${src?`<img src="${src}" onerror="this.style.display='none'" alt="${type}">`:''}  <div>All <b>${type}s</b> found!<br><span style="font-size:.9rem;">New skin unlocked!</span></div>`;
    el.style.display='block'; clearTimeout(el._t); el._t=setTimeout(()=>el.style.display='none',3600);
}
function showToast(msg,dur=2600){ const el=document.getElementById('toast'); el.textContent=msg; el.style.display='block'; clearTimeout(el._t); el._t=setTimeout(()=>el.style.display='none',dur); }

// TIMER
function startTimer(){
    if(timerInterval) clearInterval(timerInterval); secondsElapsed=0;
    timerInterval=setInterval(()=>{ secondsElapsed++; const m=Math.floor(secondsElapsed/60).toString().padStart(2,'0'),s=(secondsElapsed%60).toString().padStart(2,'0'); document.getElementById('timer-tag').innerText=`â± ${m}:${s}`; },1000);
}

// START
function startGame(){
    playerName  = document.getElementById('player-name').value.trim()||'Player';
    playerColor = document.getElementById('player-color').value;
    playerMat.color.set(playerColor);
    document.getElementById('name-label').innerText = playerName;
    updateModeHUD();
    initMultiplayer(document.getElementById('room-code').value.trim());
    document.getElementById('main-menu').style.opacity='0';
    setTimeout(()=>{
        document.getElementById('main-menu').style.display='none';
        document.getElementById('hud').style.display='block';
        document.getElementById('name-label').style.display='block';
        document.getElementById('joystick-zone').style.display='block';
        document.getElementById('jump-btn').style.display='block';
        document.getElementById('cam-hint').style.display='block';
        document.getElementById('dialogue-box').style.display='flex';
        loadMapEntities();
        buildSkinSelector(); applySkin('default');
        startTimer(); gameStarted=true; animate();
        setTimeout(()=>document.getElementById('cam-hint').style.display='none',7000);
    },500);
}

window.addEventListener('resize',()=>{ camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth,innerHeight); });
</script>
</body>
</html>