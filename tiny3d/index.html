<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Find Tiny's Family</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&family=Baloo+2:wght@700;800&display=swap" rel="stylesheet">
<style>
:root {
  --gold:#FFD166; --blue:#4ECDC4; --red:#FF6B6B; --dark:#1a1a2e; --mid:#16213e;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{overflow:hidden;background:#0a0a1a;font-family:'Nunito',sans-serif;touch-action:none;user-select:none;}
canvas{display:block;width:100vw;height:100vh;}
#ui{position:absolute;inset:0;pointer-events:none;}

/* ‚îÄ‚îÄ MENU ‚îÄ‚îÄ */
#menu{
position:absolute;inset:0;
background:radial-gradient(ellipse at 30% 40%,#0f3460 0%,#0a0a1a 70%);
display:flex;flex-direction:column;align-items:center;justify-content:center;
pointer-events:auto;transition:opacity .6s;z-index:100;overflow:hidden;
}
#menu::before{
content:'';position:absolute;inset:0;
background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Ccircle cx='30' cy='30' r='1' fill='white' opacity='.15'/%3E%3C/svg%3E");
animation:starScroll 60s linear infinite;
}
@keyframes starScroll{from{background-position:0 0}to{background-position:1000px 1000px}}
.menu-stars{position:absolute;inset:0;pointer-events:none;}
.star{position:absolute;background:#fff;border-radius:50%;animation:twinkle 3s infinite;}
@keyframes twinkle{0%,100%{opacity:.2;transform:scale(1)}50%{opacity:1;transform:scale(1.5)}}

.game-title{
font-family:'Baloo 2',cursive; font-size:clamp(2rem,7vw,4.5rem); font-weight:800;
color:#fff; text-align:center; line-height:1; margin-bottom:6px;
filter:drop-shadow(0 0 20px rgba(255,209,102,.6));
animation:titleFloat 4s ease-in-out infinite;
}
@keyframes titleFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.game-sub{color:var(--gold);font-size:1rem;font-weight:700;letter-spacing:.3em;text-transform:uppercase;margin-bottom:28px;opacity:.8;}

.menu-card{
background:rgba(255,255,255,.05);backdrop-filter:blur(20px);
border:1px solid rgba(255,255,255,.12);border-radius:24px;
padding:32px 28px;width:90%;max-width:440px;
box-shadow:0 25px 60px rgba(0,0,0,.5),inset 0 1px 0 rgba(255,255,255,.1);
}
.field-group{margin-bottom:14px;text-align:left;}
.field-label{color:rgba(255,255,255,.6);font-size:.78rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;margin-bottom:5px;display:block;}
.field-input{
width:100%;padding:12px 16px;background:rgba(255,255,255,.08);
border:1.5px solid rgba(255,255,255,.15);border-radius:12px;
color:#fff;font-family:'Nunito',sans-serif;font-size:1rem;outline:none;
transition:border-color .2s;
}
.field-input:focus{border-color:var(--gold);}
.field-input::placeholder{color:rgba(255,255,255,.3);}
.divider{height:1px;background:rgba(255,255,255,.08);margin:18px 0;}

.btn-main{
width:100%;padding:16px;font-family:'Baloo 2',cursive;font-size:1.4rem;font-weight:800;
background:linear-gradient(135deg,#FFD166,#FF6B6B);color:#fff;border:none;border-radius:14px;
cursor:pointer;box-shadow:0 8px 0 rgba(0,0,0,.3),0 0 30px rgba(255,209,102,.3);
transition:transform .1s,box-shadow .1s;margin-bottom:10px;
}
.btn-main:active{transform:translateY(6px);box-shadow:0 2px 0 rgba(0,0,0,.3);}
.btn-vc{background:linear-gradient(135deg,#4ECDC4,#44a08d);}
.btn-key{background:linear-gradient(135deg,#6A0DAD,#9b59b6);}
.btn-sm{background:rgba(255,255,255,.08);border:1.5px solid rgba(255,255,255,.15);color:#fff;border-radius:10px;padding:10px 16px;font-family:'Nunito',sans-serif;font-size:.9rem;font-weight:700;cursor:pointer;transition:.2s;}
.btn-sm:hover{background:rgba(255,255,255,.15);}

#conn-status{color:var(--gold);font-size:.85rem;font-weight:700;text-align:center;margin-top:8px;min-height:20px;}

/* ‚îÄ‚îÄ KEY MODAL ‚îÄ‚îÄ */
#key-modal{
position:absolute;inset:0;background:rgba(0,0,0,.82);
display:none;align-items:center;justify-content:center;z-index:400;pointer-events:auto;
}
.km-inner{
background:linear-gradient(135deg,#1a1a2e,#16213e);
border:2px solid rgba(106,13,173,.6);border-radius:24px;
padding:36px 32px;text-align:center;width:90%;max-width:360px;
box-shadow:0 0 60px rgba(106,13,173,.4);
}
.km-title{font-family:'Baloo 2',cursive;font-size:1.8rem;color:var(--gold);margin-bottom:8px;}
.km-sub{color:rgba(255,255,255,.5);font-size:.85rem;margin-bottom:20px;}
#key-input{
font-size:2.4rem;letter-spacing:.6rem;padding:14px;border-radius:14px;
border:2px solid rgba(106,13,173,.5);width:100%;text-align:center;
font-family:'Baloo 2',cursive;background:rgba(0,0,0,.4);color:#fff;
margin-bottom:16px;outline:none;
}
#key-input:focus{border-color:var(--gold);}
#key-status{font-size:.9rem;font-weight:700;min-height:22px;margin-top:10px;}
.km-btns{display:flex;gap:10px;justify-content:center;}

/* ‚îÄ‚îÄ HUD ‚îÄ‚îÄ */
#hud{position:absolute;top:0;left:0;display:none;pointer-events:auto;}
.hud-panel{
background:rgba(10,10,26,.75);backdrop-filter:blur(12px);
border:1px solid rgba(255,255,255,.1);border-radius:0 0 16px 0;
padding:12px 16px;min-width:180px;
}
.hud-room{color:var(--blue);font-weight:700;font-size:.85rem;margin-bottom:4px;}
.hud-time{color:#fff;font-size:1.1rem;font-weight:900;font-family:'Baloo 2',cursive;margin-bottom:8px;}
.hud-mode{background:linear-gradient(90deg,#6A0DAD,#9b59b6);color:#fff;font-size:.75rem;font-weight:700;padding:3px 10px;border-radius:20px;display:inline-block;margin-bottom:8px;}
.counts{display:grid;grid-template-columns:1fr 1fr;gap:3px;}
.cnt{font-size:.82rem;font-weight:700;color:#ddd;}
.cnt-tiny{color:var(--gold)!important;font-weight:900;}

/* ‚îÄ‚îÄ TOP RIGHT ‚îÄ‚îÄ */
#top-right{position:absolute;top:12px;right:12px;display:flex;gap:8px;align-items:center;pointer-events:auto;}
.map-sel{
background:rgba(10,10,26,.85);border:1.5px solid rgba(255,255,255,.2);
color:#fff;font-family:'Nunito',sans-serif;font-size:.9rem;font-weight:700;
padding:8px 12px;border-radius:10px;cursor:pointer;outline:none;backdrop-filter:blur(10px);
}
.icon-btn{
width:38px;height:38px;border-radius:10px;border:1.5px solid rgba(255,255,255,.2);
background:rgba(10,10,26,.85);color:#fff;font-size:1rem;cursor:pointer;
display:flex;align-items:center;justify-content:center;backdrop-filter:blur(10px);
pointer-events:auto;
}

/* ‚îÄ‚îÄ DEV PANEL ‚îÄ‚îÄ */
#dev-btns{
position:absolute;bottom:175px;right:14px;display:none;flex-direction:column;gap:6px;pointer-events:auto;z-index:160;
}
.dev-mbtn{
background:rgba(0,40,0,.9);border:1.5px solid #00ff00;color:#00ff00;
font-family:monospace;font-size:.78rem;font-weight:bold;padding:8px 12px;
border-radius:8px;cursor:pointer;text-align:left;white-space:nowrap;
}
.dev-mbtn:active{background:rgba(0,100,0,.9);}
#dev-panel{
position:absolute;top:0;left:50%;transform:translateX(-50%);
background:rgba(0,20,0,.9);border:1.5px solid #00FF00;border-radius:0 0 12px 12px;
color:#00FF00;font-family:monospace;font-size:.68rem;padding:8px 14px;
display:none;pointer-events:none;line-height:1.8;white-space:pre;z-index:150;
}

/* ‚îÄ‚îÄ FLOATING NAMES ‚îÄ‚îÄ */
.fname{
position:absolute;color:#fff;background:rgba(0,0,0,.7);
padding:2px 10px;border-radius:20px;font-size:12px;font-weight:700;
transform:translate(-50%,-100%);pointer-events:none;display:none;
text-shadow:0 1px 2px #000;border:1px solid rgba(255,255,255,.2);
white-space:nowrap;
}
.fname-dev  {background:rgba(0,160,0,.85)!important;}
.fname-admin{background:rgba(140,0,210,.85)!important;}

/* ‚îÄ‚îÄ DIALOGUE ‚îÄ‚îÄ */
#dialogue{
position:absolute;bottom:24px;left:50%;transform:translateX(-50%);
width:92%;max-width:640px;background:rgba(10,10,26,.95);
border:2px solid rgba(78,205,196,.4);border-radius:20px;padding:18px;
display:none;box-shadow:0 10px 40px rgba(0,0,0,.6),0 0 20px rgba(78,205,196,.15);
align-items:center;gap:16px;z-index:102;pointer-events:auto;
}
.d-img{width:72px;height:72px;border-radius:14px;border:2px solid var(--blue);object-fit:cover;flex-shrink:0;}
.d-text{font-size:1rem;color:#e0e0e0;line-height:1.5;flex-grow:1;}
.d-name{color:var(--blue);font-weight:900;font-size:1.1rem;}
.d-btn{background:linear-gradient(135deg,var(--blue),#44a08d);color:#fff;border:none;padding:10px 20px;border-radius:10px;cursor:pointer;font-family:'Baloo 2',cursive;font-size:1rem;font-weight:700;white-space:nowrap;}

/* ‚îÄ‚îÄ BANNERS ‚îÄ‚îÄ */
#unlock-banner{
position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
background:rgba(255,209,102,.97);border:4px solid #FF8C00;border-radius:24px;
padding:24px 36px;font-size:1.4rem;font-weight:900;color:#333;
display:none;z-index:200;text-align:center;pointer-events:none;
box-shadow:0 0 60px rgba(255,209,102,.5);animation:bannerPop .3s cubic-bezier(.34,1.56,.64,1);
}
@keyframes bannerPop{from{transform:translate(-50%,-50%) scale(.5)}to{transform:translate(-50%,-50%) scale(1)}}
#unlock-banner img{width:80px;height:80px;border-radius:12px;display:block;margin:10px auto;object-fit:cover;}
#locked-msg{
position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
background:rgba(10,10,26,.95);border:3px solid #FF4444;border-radius:20px;
padding:22px 30px;font-size:1.15rem;font-weight:700;color:#fff;
display:none;z-index:200;text-align:center;pointer-events:none;
}
#toast{
position:absolute;top:75px;left:50%;transform:translateX(-50%);
background:rgba(10,10,26,.92);color:#fff;border:1px solid rgba(255,255,255,.15);
border-radius:12px;padding:10px 22px;font-size:.92rem;font-weight:700;
display:none;z-index:250;pointer-events:none;white-space:nowrap;
backdrop-filter:blur(10px);
}

/* ‚îÄ‚îÄ SKIN SELECTOR ‚îÄ‚îÄ */
.sk-min{
position:absolute;top:-28px;right:0;background:rgba(10,10,26,.88);border:1px solid rgba(255,255,255,.15);
color:rgba(255,255,255,.7);border-radius:8px 8px 0 0;padding:3px 10px;font-size:.75rem;
cursor:pointer;pointer-events:auto;font-family:'Nunito',sans-serif;font-weight:700;
}
#skin-sel{
position:absolute;top:60px;right:12px;
z-index:103;pointer-events:auto;
background:rgba(10,10,26,.88);backdrop-filter:blur(12px);
border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:8px 10px;
gap:5px;align-items:flex-start;flex-wrap:wrap;justify-content:flex-end;
display:none;max-width:160px;flex-direction:column;
}
.sk-lbl{color:rgba(255,255,255,.6);font-weight:700;font-size:.75rem;letter-spacing:.08em;text-transform:uppercase;width:100%;text-align:center;margin-bottom:4px;}
.sk-btn{
padding:7px 14px;font-size:.82rem;font-weight:700;
background:rgba(255,255,255,.1);border:1.5px solid rgba(255,255,255,.2);
color:#fff;border-radius:8px;cursor:pointer;font-family:'Nunito',sans-serif;
transition:.15s;
}
.sk-btn:hover{background:rgba(255,255,255,.2);}
.sk-btn.sk-active{background:var(--gold);color:#333;border-color:var(--gold);}
.sk-btn.sk-dev  {background:rgba(0,160,0,.6);border-color:#00aa00;}
.sk-btn.sk-admin{background:rgba(140,0,210,.6);border-color:#8b00cc;}

/* ‚îÄ‚îÄ MOBILE JOYSTICK ‚îÄ‚îÄ */
#joy-wrap{position:absolute;bottom:28px;left:28px;display:none;pointer-events:auto;}
#joy-outer{
width:130px;height:130px;background:rgba(255,255,255,.1);
border:3px solid rgba(255,255,255,.3);border-radius:50%;
position:relative;touch-action:none;
}
#joy-inner{
width:58px;height:58px;background:rgba(255,255,255,.75);border-radius:50%;
position:absolute;top:36px;left:36px;
box-shadow:0 4px 12px rgba(0,0,0,.3);transition:none;pointer-events:none;
}
#jump-btn{
position:absolute;bottom:40px;right:40px;width:82px;height:82px;
background:rgba(255,209,102,.25);border:3px solid rgba(255,209,102,.7);
border-radius:50%;pointer-events:auto;display:none;
color:#fff;font-weight:900;font-size:1rem;font-family:'Baloo 2',cursive;
text-shadow:0 1px 3px #000;
}
#crouch-btn{
position:absolute;bottom:40px;right:134px;width:82px;height:82px;
background:rgba(78,205,196,.2);border:3px solid rgba(78,205,196,.6);
border-radius:50%;pointer-events:auto;display:none;
color:#fff;font-weight:900;font-size:.85rem;font-family:'Baloo 2',cursive;
text-shadow:0 1px 3px #000;
}

/* ‚îÄ‚îÄ CAM HINT ‚îÄ‚îÄ */
#cam-hint{
position:absolute;bottom:14px;right:14px;
background:rgba(10,10,26,.82);backdrop-filter:blur(8px);
border:1px solid rgba(255,255,255,.1);color:rgba(255,255,255,.8);
border-radius:12px;padding:10px 14px;font-size:.75rem;line-height:1.7;
display:none;pointer-events:none;
}

/* ‚îÄ‚îÄ PLAYER SPRITE CHOOSER (multiplayer) ‚îÄ‚îÄ */
#sprite-row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:6px;}
.sprite-opt{
width:48px;height:48px;border-radius:10px;border:2.5px solid rgba(255,255,255,.2);
cursor:pointer;object-fit:cover;background:#222;transition:.15s;
}
.sprite-opt.chosen{border-color:var(--gold);box-shadow:0 0 12px rgba(255,209,102,.5);}

/* ‚îÄ‚îÄ DOOR INTERACT HINT ‚îÄ‚îÄ */
#door-hint{
position:absolute;bottom:160px;left:50%;transform:translateX(-50%);
background:rgba(255,209,102,.92);color:#333;border-radius:12px;
padding:8px 20px;font-size:.9rem;font-weight:700;
display:none;pointer-events:none;z-index:105;white-space:nowrap;
box-shadow:0 4px 12px rgba(0,0,0,.3);
}
</style>
</head>
<body>
<div id="ui">

<!-- MAIN MENU -->
<div id="menu">
  <div class="menu-stars" id="menu-stars"></div>
  <div class="game-title">Find Tiny's<br>Family</div>
  <div class="game-sub">A turtle's search across the world</div>
  <div class="menu-card">
    <div class="field-group">
      <span class="field-label">Choose your character</span>
      <div id="sprite-row"></div>
    </div>
    <div class="field-group">
      <span class="field-label">Your name</span>
      <input class="field-input" id="inp-name" placeholder="Enter your name..." maxlength="14">
    </div>
    <div class="divider"></div>
    <div class="field-group">
      <span class="field-label">Join code (blank = host)</span>
      <input class="field-input" id="inp-room" placeholder="Leave blank to host a game" maxlength="12">
    </div>
    <button class="btn-main" onclick="startGame()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="white" style="vertical-align:middle;margin-right:6px"><polygon points="5,3 19,12 5,21"/></svg>
      Enter World
    </button>
    <button class="btn-main btn-vc" id="vc-btn" onclick="enableVC()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" style="vertical-align:middle;margin-right:6px"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
      Enable Voice Chat
    </button>
    <button class="btn-main btn-key" onclick="openKey()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" style="vertical-align:middle;margin-right:6px"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
      Enter Access Key
    </button>
    <div id="conn-status">Ready to connect</div>
  </div>
</div>

<!-- KEY MODAL -->
<div id="key-modal">
  <div class="km-inner">
    <div class="km-title">üîë Access Key</div>
    <div class="km-sub">Enter your 6-digit key</div>
    <input type="password" id="key-input" maxlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric" autocomplete="off">
    <div class="km-btns">
      <button class="btn-main" style="width:auto;padding:10px 24px;font-size:1rem;" onclick="submitKey()">Submit</button>
      <button class="btn-sm" onclick="closeKey()">Cancel</button>
    </div>
    <div id="key-status"></div>
  </div>
</div>

<!-- HUD -->
<div id="hud">
  <div class="hud-panel">
    <div class="hud-room" id="room-tag">Connecting...</div>
    <div class="hud-time" id="timer-tag">00:00</div>
    <div id="mode-tag" class="hud-mode" style="display:none">Mode</div>
    <div class="counts">
      <div class="cnt" id="c-dad">Dad 0/1</div>
      <div class="cnt" id="c-mum">Mum 0/1</div>
      <div class="cnt" id="c-bro">Bros 0/8</div>
      <div class="cnt" id="c-sis">Sis 0/9</div>
      <div class="cnt cnt-tiny" id="c-tiny">Tiny 0/1</div>
      <div class="cnt" id="c-map">Map 1</div>
    </div>
  </div>
</div>

<div id="top-right">
  <button class="icon-btn" id="mic-btn" onclick="toggleMic()" style="display:none" title="Toggle Mic">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg>
  </button>
  <select class="map-sel" id="map-sel" onchange="tryMap(this.value)">
    <option value="1">üè† Map 1 ‚Äî Neighborhood</option>
    <option value="2">üê¢ Map 2 ‚Äî Turtle Beach</option>
    <option value="3">üîí Map 3 ‚Äî Tiny's Hideout</option>
  </select>
</div>

<div id="dev-panel"></div>
<div id="peer-labels"></div>
<div id="name-label" class="fname">Player</div>

<!-- DIALOGUE -->
<div id="dialogue">
  <img class="d-img" id="d-img" src="friend.png"
    onerror="this.onerror=null;this.style.visibility='hidden';"
    alt="Friend">
  <div class="d-text">
    <div class="d-name">Friend üê¢</div>
    "Tiny and the whole family have gone missing! They're scattered everywhere ‚Äî some are hiding in sneaky spots. Beach is next, and Tiny has a secret classroom hideout. Can you find them all?"
  </div>
  <button class="d-btn" onclick="document.getElementById('dialogue').style.display='none'">
    Let's Go!
  </button>
</div>

<!-- SKIN SELECTOR -->
<div id="skin-sel"><span class="sk-lbl">Skin</span></div>

<!-- BANNERS -->
<div id="unlock-banner"></div>
<div id="locked-msg"></div>
<div id="toast"></div>
<div id="door-hint">üö™ Walk through the door to enter!</div>

<!-- CAM HINT -->
<div id="cam-hint">
  <b>Move</b> WASD &nbsp;|&nbsp; <b>Cam</b> Arrow keys / drag<br>
  <b>Jump</b> Space &nbsp;|&nbsp; <b>Crouch</b> C (sneak under desks!)<br>
  Scroll / pinch = zoom &nbsp;|&nbsp; Enter houses through the DOOR
</div>

<!-- MOBILE -->
<div id="dev-btns">
  <button class="dev-mbtn" onclick="flyMode=!flyMode;showToast(flyMode?'Fly ON':'Fly OFF')">‚úà Fly toggle</button>
  <button class="dev-mbtn" onclick="player.position.set(0,20,0);showToast('Reset')">‚åÇ Reset pos</button>
  <button class="dev-mbtn" onclick="adminCollect()">‚òÖ Collect all</button>
  <button class="dev-mbtn" onclick="camDist=Math.max(4,camDist-5)">+ Zoom in</button>
  <button class="dev-mbtn" onclick="camDist=Math.min(80,camDist+5)">- Zoom out</button>
</div>
<div id="joy-wrap"><div id="joy-outer"><div id="joy-inner"></div></div></div>
<button id="jump-btn">JUMP</button>
<button id="crouch-btn">CROUCH</button>
</div>

<script>
'use strict';
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONSTANTS & STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SPRITES = ['friend','dad','mum','tiny','brother','sister','admin','dev'];
const SPRITE_FALLBACK_COLORS = {
  friend:'#4ECDC4',dad:'#3498db',mum:'#e91e8c',tiny:'#FFD166',
  brother:'#2980b9',sister:'#e91e63',admin:'#9b59b6',dev:'#27ae60'
};

const SKIN_GROUPS = {dad:'dad',mum:'mum',brother:'brother',sister:'sister',tiny:'tiny'};
const KEY_ONLY_SKINS = ['dev','admin'];
const ALWAYS_UNLOCKED = ['friend'];

let playerName='Player', chosenSprite='friend', accessMode='normal';
let currentMap=1, secondsElapsed=0, timerInterval=null, gameStarted=false;
let flyMode=false, flyVelY=0, velocityY=0, isGrounded=false, isCrouching=false;

let famTargets = {dad:1,mum:1,brother:8,sister:9,tiny:1};
let famFound   = {dad:0,mum:0,brother:0,sister:0,tiny:0};
let groupUnlocked = {};

function loadUnlocked(){
  try{
    const saved=JSON.parse(localStorage.getItem('ftf_unlocked')||'[]');
    const base=[...ALWAYS_UNLOCKED];
    saved.forEach(s=>{ if(!base.includes(s)) base.push(s); });
    return base;
  } catch(e){ return [...ALWAYS_UNLOCKED]; }
}
function saveUnlocked(){
  try{ localStorage.setItem('ftf_unlocked',JSON.stringify(unlockedSkins)); } catch(e){}
}

let unlockedSkins = loadUnlocked();
let currentSkin = unlockedSkins[0];

let familyMeshes=[], obstacles=[], grassBlades=[], cloudMeshes=[];

// Door zones ‚Äî stored per house: {x, z, doorX, doorZ, doorW}
// Player can only enter/exit through the door gap
let doorZones = [];
// Under-furniture zones ‚Äî player can crouch to pass under
let underFurniture = []; // {x, z, radius, minCrouchY}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MENU ‚Äî animated stars
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function buildMenuStars(){
  const c=document.getElementById('menu-stars');
  for(let i=0;i<80;i++){
    const s=document.createElement('div');
    s.className='star';
    const sz=Math.random()*2+1;
    s.style.cssText=`width:${sz}px;height:${sz}px;top:${Math.random()*100}%;left:${Math.random()*100}%;animation-delay:${Math.random()*4}s;animation-duration:${2+Math.random()*3}s;`;
    c.appendChild(s);
  }
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SPRITE PICKER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildSpritePicker(){
  const row=document.getElementById('sprite-row');
  row.innerHTML='';
  SPRITES.forEach(name=>{
    const isUnlocked=unlockedSkins.includes(name);
    const wrap=document.createElement('div');
    wrap.style.cssText='position:relative;display:inline-block;';

    const img=document.createElement('img');
    img.className='sprite-opt';
    img.src=name+'.png';
    img.title=isUnlocked ? name[0].toUpperCase()+name.slice(1) : 'üîí Locked';
    img.dataset.name=name;
    if(!isUnlocked){ img.style.filter='grayscale(1) brightness(.4)'; img.style.cursor='not-allowed'; }

    img.onerror=function(){
      const cv=document.createElement('canvas'); cv.width=cv.height=48;
      const ctx=cv.getContext('2d');
      ctx.fillStyle=isUnlocked?(SPRITE_FALLBACK_COLORS[name]||'#555'):'#222';
      ctx.beginPath(); ctx.arc(24,24,22,0,Math.PI*2); ctx.fill();
      if(!isUnlocked){
        ctx.fillStyle='#888'; ctx.fillRect(18,22,12,10); ctx.beginPath();
        ctx.arc(24,22,5,Math.PI,0); ctx.strokeStyle='#888'; ctx.lineWidth=2; ctx.stroke();
      }
      img.src=cv.toDataURL();
    };

    if(isUnlocked){
      img.onclick=()=>{
        document.querySelectorAll('.sprite-opt').forEach(x=>x.classList.remove('chosen'));
        img.classList.add('chosen'); chosenSprite=name;
        localStorage.setItem('ftf_lastSprite',name);
      };
    } else {
      const lock=document.createElement('div');
      lock.textContent='üîí';
      lock.style.cssText='position:absolute;top:0;right:0;font-size:14px;pointer-events:none;';
      wrap.appendChild(lock);
    }

    wrap.appendChild(img);
    row.appendChild(wrap);
  });

  const last=localStorage.getItem('ftf_lastSprite');
  const defaultChoice=last&&unlockedSkins.includes(last)?last:'friend';
  chosenSprite=defaultChoice;
  const target=row.querySelector(`img[data-name="${defaultChoice}"]`);
  if(target) target.classList.add('chosen');
}
buildSpritePicker();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ACCESS KEY SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const KEYS={'212121':'dev','221122':'admin'};
function openKey(){ document.getElementById('key-modal').style.display='flex'; setTimeout(()=>document.getElementById('key-input').focus(),120); }
function closeKey(){ document.getElementById('key-modal').style.display='none'; }
document.getElementById('key-input').addEventListener('keydown',e=>{ if(e.key==='Enter')submitKey(); if(e.key==='Escape')closeKey(); });

function submitKey(){
  const v=document.getElementById('key-input').value.trim();
  const ks=document.getElementById('key-status');
  const mode=KEYS[v];
  if(mode){
    accessMode=mode;
    ks.style.color='#00FF88';
    if(mode==='dev'){
      ks.textContent='‚úî Dev Mode unlocked!';
      // Dev key only gives dev skin ‚Äî NOT admin skin
      giveExtraSkins(['dev']);
    } else {
      ks.textContent='‚úî Admin Mode unlocked!';
      // Admin key only gives admin skin ‚Äî NOT dev skin
      // Family skins still earned in-game via collection
      giveExtraSkins(['admin']);
    }
    if(gameStarted){ buildSkinSel(); updateModeTag(); if(mode==='admin') adminCollect(); }
    setTimeout(closeKey,1800);
  } else {
    ks.style.color='#FF4444'; ks.textContent='‚úò Wrong key.';
    document.getElementById('key-input').value='';
    document.getElementById('key-input').focus();
  }
}
function giveExtraSkins(arr){ let changed=false; arr.forEach(s=>{ if(!unlockedSkins.includes(s)){ unlockedSkins.push(s); changed=true; } }); if(changed){ saveUnlocked(); buildSpritePicker(); } }
function updateModeTag(){
  const mt=document.getElementById('mode-tag');
  if(accessMode==='dev')  { mt.textContent='üõ† Dev Mode';   mt.style.display='inline-block'; document.getElementById('dev-panel').style.display='block'; document.getElementById('dev-btns').style.display='flex'; }
  if(accessMode==='admin'){ mt.textContent='üëë Admin Mode'; mt.style.display='inline-block'; }
}
function adminCollect(){
  for(let i=familyMeshes.length-1;i>=0;i--){
    const f=familyMeshes[i]; scene.remove(f.mesh);
    famFound[f.type]++; checkGroupUnlock(f.type); familyMeshes.splice(i,1);
  }
  updateHUD(); showToast('üëë All family collected!');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VOICE CHAT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let peer, peers={}, localStream=null, micEnabled=false;

async function enableVC(){
  const btn=document.getElementById('vc-btn'); btn.disabled=true; btn.textContent='Requesting mic...';
  try{
    localStream=await navigator.mediaDevices.getUserMedia({audio:true});
    localStream.getAudioTracks()[0].enabled=false;
    btn.textContent='‚úî Voice Chat Ready'; btn.style.background='linear-gradient(135deg,#27ae60,#2ecc71)';
    document.getElementById('mic-btn').style.display='flex';
    showToast('Voice chat ready ‚Äî tap mic to unmute');
  } catch(e){
    btn.disabled=false; btn.textContent='Enable Voice Chat';
    showToast('Mic denied: '+e.message);
  }
}
function toggleMic(){
  if(!localStream) return;
  micEnabled=!micEnabled;
  localStream.getAudioTracks()[0].enabled=micEnabled;
  const btn=document.getElementById('mic-btn');
  btn.style.background=micEnabled?'rgba(39,174,96,.8)':'rgba(10,10,26,.85)';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NETWORKING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initNet(code){
  const tag=document.getElementById('room-tag');
  const st=document.getElementById('conn-status');
  try{
    const myId=code?null:Math.random().toString(36).substr(2,6).toUpperCase();
    peer=new Peer(myId);
    peer.on('open',id=>{
      if(code){ tag.textContent='Lobby: '+code; connectTo(code); }
      else { tag.textContent='Host: '+id; st.innerHTML=`Code: <b style="font-size:1.2rem">${id}</b>`; }
    });
    peer.on('error',e=>{ tag.textContent='Net error'; console.warn(e.type); });
    peer.on('connection',conn=>handleConn(conn));
    peer.on('call',call=>{ if(localStream) call.answer(localStream); call.on('stream',s=>playStream(s)); });
  } catch(e){ tag.textContent='Offline'; }
}
function connectTo(id){
  if(Object.keys(peers).length>=10){ showToast('Max 10 players'); return; }
  const conn=peer.connect(id); handleConn(conn);
  if(localStream){ const c=peer.call(id,localStream); c.on('stream',s=>playStream(s)); }
}
function handleConn(conn){
  conn.on('open',()=>conn.send({type:'init',name:playerName,sprite:chosenSprite}));
  conn.on('data',data=>{
    if(!peers[conn.peer]) makePeerMesh(conn.peer);
    const p=peers[conn.peer];
    if(data.type==='init'){ loadSpriteFor(p.mesh,data.sprite); p.labelDiv.innerText=data.name; p.conn=conn; }
    else if(data.type==='move'){ p.mesh.position.set(data.x,data.y,data.z); p.mesh.lookAt(camera.position.x,data.y,camera.position.z); }
  });
  conn.on('close',()=>{ if(peers[conn.peer]){ scene.remove(peers[conn.peer].mesh); peers[conn.peer].labelDiv.remove(); delete peers[conn.peer]; } });
}
function makePeerMesh(id){
  const mesh=new THREE.Mesh(new THREE.PlaneGeometry(2,2.2),new THREE.MeshStandardMaterial({color:0xffffff,side:THREE.DoubleSide,transparent:true}));
  mesh.castShadow=true; scene.add(mesh);
  const lbl=document.createElement('div'); lbl.className='fname'; lbl.style.display='block'; lbl.innerText='Player';
  document.getElementById('peer-labels').appendChild(lbl);
  peers[id]={mesh,labelDiv:lbl,conn:null};
}
function loadSpriteFor(mesh,spriteName){
  tLoader.load(spriteName+'.png',tex=>{ mesh.material.map=tex; mesh.material.color.set(0xFFFFFF); mesh.material.needsUpdate=true; },null,()=>{ mesh.material.color.set(SPRITE_FALLBACK_COLORS[spriteName]||'#fff'); });
}
function playStream(stream){ const a=document.createElement('audio'); a.srcObject=stream; a.autoplay=true; a.style.display='none'; document.body.appendChild(a); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  THREE.JS CORE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(68,innerWidth/innerHeight,.1,1200);
const renderer=new THREE.WebGLRenderer({antialias:true,powerPreference:'high-performance'});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
renderer.shadowMap.enabled=true;
renderer.shadowMap.type=THREE.PCFSoftShadowMap;
renderer.toneMapping=THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure=1.4;
document.body.insertBefore(renderer.domElement,document.getElementById('ui'));

const tLoader=new THREE.TextureLoader();

// ‚îÄ‚îÄ LIGHTING ‚îÄ‚îÄ
const hemiLight=new THREE.HemisphereLight(0xffe5a0,0x3a7010,1.2);
scene.add(hemiLight);

const sun=new THREE.DirectionalLight(0xffdd55,2.6);
sun.castShadow=true;
sun.shadow.mapSize.width=sun.shadow.mapSize.height=4096;
sun.shadow.camera.near=1; sun.shadow.camera.far=800;
sun.shadow.camera.left=-250; sun.shadow.camera.right=250;
sun.shadow.camera.top=250;   sun.shadow.camera.bottom=-250;
sun.shadow.bias=-0.0005;
sun.shadow.normalBias=0.02;
scene.add(sun);

const fillLight=new THREE.DirectionalLight(0x4488ff,.35);
fillLight.position.set(-1,.5,-1);
scene.add(fillLight);

const ambient=new THREE.AmbientLight(0xffd0a0,.25);
scene.add(ambient);

let dayT=Math.PI*0.08;
let lastSunH=-1;
const DAY_SPEED=0.00012;

scene.fog=new THREE.FogExp2(0xffe8b0,.0015);
scene.background=new THREE.Color(0xff9944);

// ‚îÄ‚îÄ SKY DOME ‚îÄ‚îÄ
const skyGeo=new THREE.SphereGeometry(900,12,6);
skyGeo.scale(-1,1,-1);
const skyColors=new Float32Array(skyGeo.attributes.position.count*3);
skyGeo.setAttribute('color',new THREE.BufferAttribute(skyColors,3));
const skyMat=new THREE.MeshBasicMaterial({vertexColors:true,depthWrite:false,fog:false});
const skyMesh=new THREE.Mesh(skyGeo,skyMat);
skyMesh.renderOrder=-1;
scene.add(skyMesh);

function updateSky(sunH,sinT){
  const pos=skyGeo.attributes.position;
  const col=skyGeo.attributes.color;
  const apex   = sunH>0.01 ? new THREE.Color(0x1a6ecc).lerp(new THREE.Color(0x0a2a60),Math.max(0,1-sunH*2)) : new THREE.Color(0x050520);
  const midSky = sunH>0.01 ? new THREE.Color(0x44aaee).lerp(new THREE.Color(0x88ccff),sunH) : new THREE.Color(0x101840);
  const horiz  = sunH>0.01 ? new THREE.Color(0xff7700).lerp(new THREE.Color(0xbbddff),Math.min(1,sunH*2)) : new THREE.Color(0x1a0808);
  if(sunH<.02){ horiz.set(0xff5500); midSky.set(0x331122); }
  for(let i=0;i<pos.count;i++){
    const yN=Math.max(-1,Math.min(1,pos.getY(i)/900));
    const t=Math.max(0,yN);
    let c;
    if(t<0.15) c=horiz.clone().lerp(midSky,t/0.15);
    else c=midSky.clone().lerp(apex,(t-.15)/.85);
    col.setXYZ(i,c.r,c.g,c.b);
  }
  col.needsUpdate=true;
}

// ‚îÄ‚îÄ TERRAIN ‚îÄ‚îÄ
const terrainMats={
  1:new THREE.MeshStandardMaterial({color:0x4a8c28,roughness:.9,metalness:0}),
  2:new THREE.MeshStandardMaterial({color:0xf0d090,roughness:.85,metalness:0}),
  3:new THREE.MeshStandardMaterial({color:0xd4c4a0,roughness:.7,metalness:0})
};
tLoader.load('grass.png',tex=>{ tex.wrapS=tex.wrapT=THREE.RepeatWrapping; tex.repeat.set(80,80); terrainMats[1].map=tex; terrainMats[1].needsUpdate=true; },null,()=>{});

let terrain=null;
const HOUSE_PADS=[
  {x:30,z:30},{x:80,z:-20},{x:-60,z:50},{x:50,z:-80},{x:-90,z:-30},
  {x:110,z:70},{x:-40,z:-120},{x:0,z:110},{x:130,z:-100},
  {x:-120,z:80},{x:70,z:150},{x:-150,z:-80},{x:20,z:-160},{x:160,z:20},{x:-80,z:160}
];
const PAD_R=18;

function buildTerrain(m){
  if(terrain){ scene.remove(terrain); terrain.geometry.dispose(); terrain=null; }
  const size = m===3 ? 140 : 800;
  const segs = m===3 ? 4   : 80;
  const geo=new THREE.PlaneGeometry(size,size,segs,segs);
  geo.rotateX(-Math.PI/2);
  if(m!==3){
    const pos=geo.attributes.position;
    for(let i=0;i<pos.count;i++){
      const x=pos.getX(i),z=pos.getZ(i);
      let y=0;
      if(m===1){
        y = Math.sin(x*0.012)*Math.cos(z*0.012)*18
          + Math.sin(x*0.03+1)*Math.cos(z*0.025+2)*8
          + Math.sin(x*0.07)*Math.cos(z*0.08)*3;
        let flatBlend=0;
        for(const pad of HOUSE_PADS){
          const dist=Math.sqrt((x-pad.x)**2+(z-pad.z)**2);
          if(dist<PAD_R){
            const inner=PAD_R-5;
            flatBlend=Math.max(flatBlend, dist<=inner ? 1 : 1-(dist-inner)/5);
          }
        }
        y=y*(1-flatBlend);
      }
      pos.setY(i,y);
    }
    geo.computeVertexNormals();
  }
  terrain=new THREE.Mesh(geo,terrainMats[m]);
  terrain.receiveShadow=true; scene.add(terrain);
}

// ‚îÄ‚îÄ PLAYER ‚îÄ‚îÄ
const playerGeo=new THREE.PlaneGeometry(2.4,2.7);
const playerMat=new THREE.MeshStandardMaterial({color:0x4ECDC4,side:THREE.DoubleSide,transparent:true,alphaTest:.05});
const player=new THREE.Mesh(playerGeo,playerMat);
player.castShadow=true; scene.add(player);

const disc=new THREE.Mesh(new THREE.CircleGeometry(.9,16),new THREE.MeshBasicMaterial({color:0,transparent:true,opacity:.22}));
disc.rotation.x=-Math.PI/2; scene.add(disc);

// ‚îÄ‚îÄ RAYCASTER ‚îÄ‚îÄ
const gRay=new THREE.Raycaster();
const dVec=new THREE.Vector3(0,-1,0);
const _thCache=new Map();
function terrainH(x,z){
  if(!terrain) return 0;
  const key=(Math.round(x*2)/2)+','+(Math.round(z*2)/2);
  if(_thCache.has(key)) return _thCache.get(key);
  gRay.set(new THREE.Vector3(x,500,z),dVec);
  const h=gRay.intersectObject(terrain);
  const y=h.length?h[0].point.y:0;
  if(_thCache.size>2000) _thCache.clear();
  _thCache.set(key,y);
  return y;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CAMERA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let camYaw=0, camPitch=.42, camDist=22, camDistTarget=22;
const housePositions=[]; // {x, z, w, d, doorX, doorZ, doorW, doorFace}
const CAM_SPD=.03;

let mDrag=false,lmx=0,lmy=0;
renderer.domElement.addEventListener('mousedown',e=>{ if(e.button===0){mDrag=true;lmx=e.clientX;lmy=e.clientY;} });
renderer.domElement.addEventListener('mousemove',e=>{ if(!mDrag) return; camYaw-=(e.clientX-lmx)*.004; camPitch-=(e.clientY-lmy)*.004; camPitch=clamp(camPitch,.05,1.45); lmx=e.clientX;lmy=e.clientY; });
renderer.domElement.addEventListener('mouseup',()=>mDrag=false);
renderer.domElement.addEventListener('mouseleave',()=>mDrag=false);
renderer.domElement.addEventListener('wheel',e=>{ camDistTarget=clamp((camDistTarget||camDist)+e.deltaY*.06,4,80); },{passive:true});

const camt={};
renderer.domElement.addEventListener('touchstart',e=>{ for(const t of e.changedTouches) if(t.clientX>innerWidth*.45) camt[t.identifier]={x:t.clientX,y:t.clientY}; },{passive:true});
renderer.domElement.addEventListener('touchmove',e=>{ for(const t of e.changedTouches){ if(camt[t.identifier]){ const p=camt[t.identifier]; camYaw-=(t.clientX-p.x)*.005; camPitch-=(t.clientY-p.y)*.005; camPitch=clamp(camPitch,.05,1.45); camt[t.identifier]={x:t.clientX,y:t.clientY}; e.preventDefault(); } } },{passive:false});
renderer.domElement.addEventListener('touchend',e=>{ for(const t of e.changedTouches) delete camt[t.identifier]; },{passive:true});

let insideHouseIdx=-1;
function doUpdateCamera(){
  insideHouseIdx=-1;
  if(currentMap===1 && housePositions.length){
    for(let i=0;i<housePositions.length;i++){
      const h=housePositions[i];
      const dx=player.position.x-h.x, dz=player.position.z-h.z;
      const inside=Math.abs(dx)<h.w/2-0.5&&Math.abs(dz)<h.d/2-0.5;
      if(inside){ insideHouseIdx=i; break; }
    }
    if(insideHouseIdx>=0) camDistTarget=8;
    else camDistTarget=22;
  } else {
    camDistTarget=currentMap===3?11:22;
  }
  camDist+=(camDistTarget-camDist)*.1;

  // Crouching: lower camera, look along ground
  const crouchPitch = isCrouching ? 0.06 : camPitch;
  const crouchDist  = isCrouching ? camDist*.85 : camDist;
  const lookH = isCrouching ? 0.2 : 1.2;
  camera.position.set(
    player.position.x+Math.sin(camYaw)*crouchDist*Math.cos(crouchPitch),
    player.position.y+Math.sin(crouchPitch)*crouchDist,
    player.position.z+Math.cos(camYaw)*crouchDist*Math.cos(crouchPitch)
  );
  camera.lookAt(player.position.x,player.position.y+lookH,player.position.z);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SKINS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SKIN_IMGS={friend:'friend.png',dad:'dad.png',mum:'mum.png',brother:'brother.png',sister:'sister.png',tiny:'tiny.png',admin:'admin.png',dev:'dev.png'};
const skinCache={};
function loadSkinTex(name,cb){
  if(name in skinCache){cb(skinCache[name]);return;}
  if(!SKIN_IMGS[name]){skinCache[name]=null;cb(null);return;}
  tLoader.load(SKIN_IMGS[name],t=>{skinCache[name]=t;cb(t);},null,()=>{skinCache[name]=null;cb(null);});
}
function applySkin(name){
  currentSkin=name;
  loadSkinTex(name,tex=>{
    playerMat.map=tex||null;
    playerMat.color.set(tex?0xFFFFFF:SPRITE_FALLBACK_COLORS[name]||0x4ECDC4);
    playerMat.needsUpdate=true;
  });
  document.querySelectorAll('.sk-btn').forEach(b=>b.classList.toggle('sk-active',b.dataset.s===name));
  const dImg=document.getElementById('d-img');
  if(dImg){
    dImg.src=name+'.png';
    dImg.onerror=function(){ this.onerror=null; this.style.visibility='hidden'; };
  }
  const dName=document.querySelector('#dialogue .d-name');
  if(dName) dName.textContent=(name[0].toUpperCase()+name.slice(1))+' üê¢';
}
let skinSelCollapsed=false;
function buildSkinSel(){
  const sel=document.getElementById('skin-sel');
  sel.innerHTML='';
  const mb=document.createElement('button'); mb.className='sk-min';
  mb.textContent=skinSelCollapsed?'‚ñ≤ Skin':'‚ñº Hide';
  mb.onclick=e=>{ e.stopPropagation(); skinSelCollapsed=!skinSelCollapsed; buildSkinSel(); };
  sel.appendChild(mb);
  if(!skinSelCollapsed){
    const lbl=document.createElement('span'); lbl.className='sk-lbl'; lbl.textContent='Skin'; sel.appendChild(lbl);
    unlockedSkins.forEach(s=>{
      const b=document.createElement('button'); b.className='sk-btn'; b.dataset.s=s;
      b.textContent=s==='dev'?'Dev':s==='admin'?'Admin':s[0].toUpperCase()+s.slice(1);
      if(s==='dev') b.classList.add('sk-dev');
      if(s==='admin') b.classList.add('sk-admin');
      if(s===currentSkin) b.classList.add('sk-active');
      b.onclick=()=>applySkin(s); sel.appendChild(b);
    });
  }
  sel.style.display = unlockedSkins.length > 1 ? 'flex' : 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FAMILY SPAWN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MAP_ROSTER = {
  1:[{type:'dad',s:2.4},{type:'mum',s:2.2},{type:'brother',s:1.9},{type:'brother',s:1.9},{type:'brother',s:1.9},{type:'brother',s:1.9},{type:'sister',s:1.7},{type:'sister',s:1.7},{type:'sister',s:1.7}],
  2:[{type:'brother',s:1.9},{type:'brother',s:1.9},{type:'brother',s:1.9},{type:'brother',s:1.9},{type:'sister',s:1.7},{type:'sister',s:1.7},{type:'sister',s:1.7},{type:'sister',s:1.7},{type:'sister',s:1.7},{type:'sister',s:1.7}],
  3:[{type:'tiny',s:1.0}]
};

const HARD_SPOTS_MAP1 = [
  [30,30],[80,-20],[-60,50],[50,-80],[-90,-30],
  [110,70],[-40,-120],[0,110],[130,-100]
];

function spawnFamily(){
  if(currentMap===3) return;
  const roster=MAP_ROSTER[currentMap]||[];
  roster.forEach((mem,idx)=>{
    const mat=new THREE.MeshStandardMaterial({
      color:typeCol(mem.type),side:THREE.DoubleSide,transparent:true,alphaTest:.05
    });
    tLoader.load(mem.type+'.png',
      tex=>{ mat.map=tex; mat.color.set(0xFFFFFF); mat.needsUpdate=true; },
      null, ()=>{}
    );
    const mesh=new THREE.Mesh(new THREE.PlaneGeometry(mem.s,mem.s*1.3),mat);
    let mx,mz;
    if(currentMap===1 && HARD_SPOTS_MAP1[idx]){
      const hs=HARD_SPOTS_MAP1[idx];
      mx=hs[0]+(Math.random()-.5)*6; mz=hs[1]+(Math.random()-.5)*6;
    } else if(currentMap===2){
      mx=(Math.random()-.5)*460; mz=(Math.random()-.5)*180;
      if(mz<-120) mz=-90+Math.random()*40;
    } else {
      mx=(Math.random()-.5)*380; mz=(Math.random()-.5)*380;
    }
    let ty=0;
    try{ ty=terrainH(mx,mz); } catch(e){ ty=0; }
    if(!isFinite(ty)||ty==null) ty=0;
    mesh.position.set(mx, ty+mem.s*.6+.1, mz);
    mesh.castShadow=false;
    scene.add(mesh);
    familyMeshes.push({mesh,type:mem.type});
  });
}

function typeCol(t){ return {dad:0x3498db,mum:0xe91e8c,brother:0x2980b9,sister:0xe91e63,tiny:0xFFD166}[t]||0xffffff; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MAP BUILDERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function mkMesh(geo,params){ return new THREE.Mesh(geo,new THREE.MeshStandardMaterial(params)); }

function clearScene(){
  _thCache.clear();
  familyMeshes.forEach(f=>scene.remove(f.mesh));
  obstacles.forEach(o=>scene.remove(o.mesh||o));
  grassBlades.forEach(g=>scene.remove(g));
  scene.children.filter(c=>c.userData.deco).forEach(c=>scene.remove(c));
  familyMeshes=[]; obstacles=[]; grassBlades=[]; housePositions.length=0;
  doorZones=[]; underFurniture=[];
}

function loadMap(m){
  clearScene(); buildTerrain(m); setLighting(m);
  if(m===1) buildNeighborhood();
  else if(m===2) buildBeach();
  else buildClassroom();

  // FIX: Spawn player at ground level on map 3 (classroom floor = 0.15)
  if(m===3){
    player.position.set(0, 1.5, 20); // front of classroom, on floor
  } else {
    player.position.set(0, terrainH(0,0)+1.5, 0);
  }
  flyVelY=0; velocityY=0; isGrounded=false;
  document.getElementById('c-map').textContent='Map '+m;
  updateHUD();
  if(accessMode==='admin') setTimeout(adminCollect,400);
}

function setLighting(m){
  if(m===1){
    hemiLight.color.set(0xffeaa0); hemiLight.groundColor.set(0x4a7a20); hemiLight.intensity=1.0;
    ambient.color.set(0xffd0a0); ambient.intensity=.25;
    scene.fog.color.set(0xffcc88); scene.fog.density=.0016;
  } else if(m===2){
    hemiLight.color.set(0xaaddff); hemiLight.groundColor.set(0xf0d090); hemiLight.intensity=1.2;
    ambient.color.set(0xbbeeff); ambient.intensity=.3;
    scene.fog.color.set(0xaaccee); scene.fog.density=.0012;
  } else {
    hemiLight.color.set(0xffeedd); hemiLight.groundColor.set(0x997755); hemiLight.intensity=.7;
    ambient.color.set(0xffddbf); ambient.intensity=.45;
    scene.fog.color.set(0xeeddcc); scene.fog.density=.008;
  }
}

// ‚îÄ‚îÄ MAP 1: NEIGHBORHOOD ‚îÄ‚îÄ
function buildNeighborhood(){
  HOUSE_PADS.forEach(({x,z})=>{ addHouse(x,0,z); });

  for(let i=0;i<60;i++){
    const tx=(Math.random()-.5)*700, tz=(Math.random()-.5)*700;
    const nearHouse=HOUSE_PADS.some(h=>Math.sqrt((tx-h.x)**2+(tz-h.z)**2)<PAD_R+4);
    if(!nearHouse) addTree(tx,tz);
  }

  for(let i=0;i<30;i++){
    const s=Math.random()*3+1;
    const rx=(Math.random()-.5)*650, rz=(Math.random()-.5)*650;
    const nearHouse=HOUSE_PADS.some(h=>Math.sqrt((rx-h.x)**2+(rz-h.z)**2)<PAD_R+2);
    if(nearHouse) continue;
    const rock=mkMesh(new THREE.DodecahedronGeometry(s,0),{color:0x777777,roughness:.95,metalness:.05});
    rock.position.set(rx,terrainH(rx,rz)+s*.4,rz); rock.receiveShadow=true; rock.userData.deco=true; scene.add(rock);
    obstacles.push({mesh:rock,radius:s*1.1,x:rx,z:rz});
  }

  spawnGrass(80,700);
  spawnFamily();
}

// ‚îÄ‚îÄ HOUSE BUILDER ‚Äî DOOR-ONLY ENTRY ‚îÄ‚îÄ
// The front wall has a door gap. The collision system only blocks the wall sections,
// leaving the door opening free. Player can only enter/exit through the door.
function addHouse(x,ty,z){
  const W=18, D=16, H=8, WT=1.0;
  const DOOR_W=3.2, DOOR_H=4.4;
  const idx=housePositions.length;
  const wallCols=[0xF2E0C0,0xDDE8DC,0xF5D9A8,0xE8D8C0,0xD0E0D0,0xEEDDCC];
  const roofCols=[0xA03020,0x6B2E1A,0x2A5078,0x404040,0x703010];
  const wMat=new THREE.MeshStandardMaterial({color:wallCols[idx%wallCols.length],roughness:.88});
  const rMat=new THREE.MeshStandardMaterial({color:roofCols[idx%roofCols.length],roughness:.92});
  const fMat=new THREE.MeshStandardMaterial({color:0xC8A878,roughness:.7});
  const winMat=new THREE.MeshStandardMaterial({color:0x88CCFF,roughness:.05,metalness:.2,transparent:true,opacity:.55});
  const frMat=new THREE.MeshStandardMaterial({color:0xDDDDDD,roughness:.8});
  const dMat=new THREE.MeshStandardMaterial({color:0x5a3010,roughness:.85});

  function box(geo,mat,px,py,pz,ry){
    const m=new THREE.Mesh(geo,mat);
    m.position.set(px,py,pz);
    if(ry) m.rotation.y=ry;
    m.castShadow=true; m.receiveShadow=true; m.userData.deco=true; scene.add(m); return m;
  }

  // Floor slab
  box(new THREE.BoxGeometry(W+WT*2+1,10,D+WT*2+1),
    new THREE.MeshStandardMaterial({color:0x4a8c28,roughness:.9}), x,-5,z);
  box(new THREE.BoxGeometry(W-0.2,0.2,D-0.2),fMat, x,0.1,z);

  // Walls
  const fSide=(W-DOOR_W)/2;
  box(new THREE.BoxGeometry(W+WT*2,H,WT),wMat, x,H/2,z-D/2-WT/2);        // back
  box(new THREE.BoxGeometry(WT,H,D+WT*2),wMat, x-W/2-WT/2,H/2,z);        // left
  box(new THREE.BoxGeometry(WT,H,D+WT*2),wMat, x+W/2+WT/2,H/2,z);        // right
  box(new THREE.BoxGeometry(fSide,H,WT),wMat, x-DOOR_W/2-fSide/2,H/2,z+D/2+WT/2); // front-L
  box(new THREE.BoxGeometry(fSide,H,WT),wMat, x+DOOR_W/2+fSide/2,H/2,z+D/2+WT/2); // front-R
  box(new THREE.BoxGeometry(W+WT*2,H-DOOR_H,WT),wMat, x,DOOR_H+(H-DOOR_H)/2,z+D/2+WT/2); // front-top

  // Roof ‚Äî proper gabled prism via BufferGeometry (outward-facing slopes)
  const roofW=W+WT*2+1.5, roofD=D+WT*2+1.5, roofH=H*0.6;
  {
    const hw=roofW/2, hd=roofD/2;
    // 6 verts: 4 base corners + 2 ridge points along X at top-centre
    const verts=new Float32Array([
      -hw,0,-hd,  // 0 left-front
       hw,0,-hd,  // 1 right-front
       hw,0, hd,  // 2 right-back
      -hw,0, hd,  // 3 left-back
      -hw,roofH,0,// 4 left-ridge
       hw,roofH,0,// 5 right-ridge
    ]);
    const idx=new Uint16Array([
      // front slope (facing -Z)
      0,4,1, 1,4,5,
      // back slope (facing +Z)
      2,5,3, 3,5,4,
      // left gable (facing -X)
      0,3,4,
      // right gable (facing +X)
      1,5,2,
      // base (optional, faces down ‚Äî useful for shadows)
      0,1,2, 0,2,3,
    ]);
    const geo=new THREE.BufferGeometry();
    geo.setAttribute('position',new THREE.BufferAttribute(verts,3));
    geo.setIndex(new THREE.BufferAttribute(idx,1));
    geo.computeVertexNormals();
    const roofMesh=new THREE.Mesh(geo,rMat);
    roofMesh.position.set(x,H+0.25,z);
    roofMesh.castShadow=true; roofMesh.receiveShadow=true; roofMesh.userData.deco=true;
    scene.add(roofMesh);
  }
  // Eave lip at base of roof
  box(new THREE.BoxGeometry(roofW+.2,0.4,roofD+.2),rMat, x,H+.2,z);
  // Ridge cap
  box(new THREE.BoxGeometry(roofW+0.3,0.3,0.3),rMat, x,H+0.25+roofH,z);

  // Ceiling
  box(new THREE.BoxGeometry(W+.2,.25,D+.2),new THREE.MeshStandardMaterial({color:0xEEEEE8,roughness:.9}), x,H-.12,z);

  // Windows
  const wY=H*0.62, wW=2.0, wH2=1.7;
  function win(px,pz,ry){
    box(new THREE.BoxGeometry(wW+.5,wH2+.5,WT+.1),frMat,px,wY,pz,ry);
    box(new THREE.BoxGeometry(wW,wH2,WT*.25),winMat,px,wY,pz,ry);
  }
  win(x-W*.25, z-D/2-WT/2, 0); win(x+W*.25, z-D/2-WT/2, 0);
  win(x-W/2-WT/2, z-D*.2, Math.PI/2); win(x-W/2-WT/2, z+D*.2, Math.PI/2);
  win(x+W/2+WT/2, z-D*.2, Math.PI/2); win(x+W/2+WT/2, z+D*.2, Math.PI/2);
  if(fSide>3) win(x-(DOOR_W/2+fSide*.5), z+D/2+WT/2, 0);
  if(fSide>3) win(x+(DOOR_W/2+fSide*.5), z+D/2+WT/2, 0);

  // Door (visual only ‚Äî open/ajar look)
  // Door is slightly open to invite entry
  const doorM=box(new THREE.BoxGeometry(DOOR_W-.4,DOOR_H-.4,.12),dMat, x-(DOOR_W*.35),DOOR_H/2,z+D/2+WT*.55);
  doorM.rotation.y=Math.PI*0.3; // slightly open

  // Interior furniture
  const bedMesh=box(new THREE.BoxGeometry(4.5,.8,6.5),new THREE.MeshStandardMaterial({color:0x5577AA,roughness:.8}), x+W*.22,.4,z-D*.18);
  box(new THREE.BoxGeometry(3.5,H*.65,1.8),new THREE.MeshStandardMaterial({color:0x7A5525,roughness:.85}), x-W*.28,H*.33,z+D*.2);
  if(idx<5){
    const pl=new THREE.PointLight(0xFFCC88,.8,20);
    pl.position.set(x,H-.8,z); pl.userData.deco=true; scene.add(pl);
  }

  // Register bed for crouch-under
  underFurniture.push({x:x+W*.22, z:z-D*.18, radius:3.5, clearanceY:1.2, topY:0.8+.4});

  // ‚îÄ‚îÄ COLLISION ‚Äî DOOR-ONLY ENTRY ‚îÄ‚îÄ
  // Back wall ‚Äî solid
  const R=WT+.8;
  for(let i=0;i<=W+WT*2;i+=2.5) obstacles.push({x:x-W/2-WT+i, z:z-D/2-WT, radius:R});
  // Left wall ‚Äî solid
  for(let i=0;i<=D+WT*2;i+=2.5) obstacles.push({x:x-W/2-WT, z:z-D/2-WT+i, radius:R});
  // Right wall ‚Äî solid
  for(let i=0;i<=D+WT*2;i+=2.5) obstacles.push({x:x+W/2+WT, z:z-D/2-WT+i, radius:R});
  // Front wall ‚Äî left section (to left of door)
  for(let i=0;i<=fSide+WT;i+=2.5) obstacles.push({x:x-W/2-WT+i, z:z+D/2+WT, radius:R, isDoorWall:true});
  // Front wall ‚Äî right section (to right of door)
  for(let i=0;i<=fSide+WT;i+=2.5) obstacles.push({x:x+DOOR_W/2+i, z:z+D/2+WT, radius:R, isDoorWall:true});
  // Furniture collision ‚Äî only when NOT crouching
  obstacles.push({x:x+W*.22, z:z-D*.18, radius:2.6, requiresStanding:true}); // bed
  obstacles.push({x:x-W*.28, z:z+D*.2, radius:2.0});                         // wardrobe

  housePositions.push({
    x, z, w:W+WT*2, d:D+WT*2,
    doorX:x, doorZ:z+D/2+WT,
    doorW:DOOR_W+0.5 // slightly generous door opening
  });
}

function addTree(x,z){
  const ty=terrainH(x,z);
  const trunk=mkMesh(new THREE.CylinderGeometry(.35,.6,5+Math.random()*3,4),{color:0x6b3d1e,roughness:1});
  trunk.position.set(x,ty+3,z); trunk.castShadow=true; trunk.userData.deco=true; scene.add(trunk);
  const cr=3+Math.random()*3;
  const crown=mkMesh(new THREE.SphereGeometry(cr,5,3),{color:0x2d7a20+(Math.floor(Math.random()*4)*0x050000),roughness:1});
  crown.position.set(x,ty+5+cr*.6,z); crown.castShadow=true; crown.userData.deco=true; scene.add(crown);
  obstacles.push({mesh:trunk,radius:1.4,x,z});
}

// ‚îÄ‚îÄ MAP 2: TURTLE BEACH ‚îÄ‚îÄ
function buildBeach(){
  const ocean=mkMesh(new THREE.PlaneGeometry(3000,1200),{color:0x0d7ab5,roughness:.08,metalness:.2});
  ocean.rotation.x=-Math.PI/2; ocean.position.set(0,-3,0); ocean.userData.deco=true; scene.add(ocean);
  const wet=mkMesh(new THREE.PlaneGeometry(3000,60),{color:0xd4a84a,roughness:.9});
  wet.rotation.x=-Math.PI/2; wet.position.set(0,0.01,-170); wet.userData.deco=true; scene.add(wet);

  for(let i=0;i<70;i++){
    const px=(Math.random()-.5)*700, pz=(Math.random()-.5)*200;
    addPalm(px,pz);
  }
  spawnBeachGrass(80,600,180);
  for(let i=0;i<20;i++) addUmbrella((Math.random()-.5)*500,(Math.random()-.5)*200);

  for(let i=0;i<20;i++){
    const s=Math.random()*3+.8;
    const rx=(Math.random()-.5)*600, rz=(Math.random()-.5)*220;
    const rock=mkMesh(new THREE.SphereGeometry(s,5,4),{color:0xB0A090,roughness:.95});
    rock.position.set(rx,terrainH(rx,rz)+s*.4,rz); rock.castShadow=true; rock.userData.deco=true; scene.add(rock);
    obstacles.push({mesh:rock,radius:s*1.2,x:rx,z:rz});
  }

  for(let i=0;i<20;i++){
    const dx=(Math.random()-.5)*600, dz=(Math.random()-.5)*220;
    const dune=mkMesh(new THREE.SphereGeometry(8+Math.random()*14,8,6),{color:0xe8c870,roughness:1});
    dune.scale.y=.22; dune.position.set(dx,.2,dz); dune.receiveShadow=true; dune.userData.deco=true; scene.add(dune);
  }

  for(let i=0;i<14;i++){
    const sx=(Math.random()-.5)*500, sz=(Math.random()-.5)*200;
    addShell(sx,sz);
  }

  spawnFamily();
}

function spawnBeachGrass(count,spreadX,spreadZ){
  const gm=new THREE.MeshStandardMaterial({color:0xc8c040,side:THREE.DoubleSide,transparent:true,alphaTest:.08,roughness:1});
  for(let i=0;i<count;i++){
    const gx=(Math.random()-.5)*spreadX, gz=(Math.random()-.5)*spreadZ;
    const g=new THREE.Mesh(new THREE.PlaneGeometry(1.2+Math.random()*.8,2+Math.random()*1.5),gm);
    g.position.set(gx,terrainH(gx,gz)+1+Math.random()*.5,gz);
    g.rotation.y=Math.random()*Math.PI;
    scene.add(g); grassBlades.push(g);
  }
}

function addPalm(x,z){
  const ty=terrainH(x,z);
  const trunk=mkMesh(new THREE.CylinderGeometry(.25,.5,8+Math.random()*4,6),{color:0x9b7845,roughness:1});
  trunk.position.set(x,ty+5,z); trunk.rotation.z=(Math.random()-.5)*.3; trunk.castShadow=true; trunk.userData.deco=true; scene.add(trunk);
  const top=mkMesh(new THREE.SphereGeometry(3.5,8,5),{color:0x2ea020+(Math.floor(Math.random()*3)*0x030000),roughness:1});
  top.scale.y=.3; top.position.set(x+Math.sin(trunk.rotation.z)*8,ty+10,z); top.userData.deco=true; scene.add(top);
  obstacles.push({mesh:trunk,radius:1.2,x,z});
}

function addUmbrella(x,z){
  const ty=terrainH(x,z);
  const pole=mkMesh(new THREE.CylinderGeometry(.08,.08,4,5),{color:0xaaaaaa});
  pole.position.set(x,ty+2,z); pole.userData.deco=true; scene.add(pole);
  const cols=[0xff4444,0xffcc00,0x44aaff,0xff8800,0xff44ff,0x44ff88];
  const canopy=mkMesh(new THREE.ConeGeometry(3.2,1.2,8),{color:cols[Math.floor(Math.random()*cols.length)]});
  canopy.rotation.x=Math.PI; canopy.position.set(x,ty+4.2,z); canopy.userData.deco=true; scene.add(canopy);
  const towel=mkMesh(new THREE.BoxGeometry(3.5,.05,5),{color:cols[Math.floor(Math.random()*cols.length)],roughness:.9});
  towel.position.set(x+(Math.random()-.5)*4,ty+.06,z+(Math.random()-.5)*4); towel.userData.deco=true; scene.add(towel);
}

function addShell(x,z){
  const ty=terrainH(x,z);
  const shell=mkMesh(new THREE.SphereGeometry(1.2,6,5),{color:0x8B6914,roughness:.9});
  shell.scale.y=.55; shell.position.set(x,ty+.5,z); shell.userData.deco=true; scene.add(shell);
}

// ‚îÄ‚îÄ MAP 3: CLASSROOM ‚îÄ‚îÄ
// FIX: Spawn player at floor level (y=1.5), not above ceiling
// FIX: Tiny is always in the classroom with a guaranteed visible spot + bigger size
function buildClassroom(){
  const W=80, D=60, H=9, WT=1.5;
  const wMat=new THREE.MeshStandardMaterial({color:0xF2EFE8,roughness:.85});
  const fMat=new THREE.MeshStandardMaterial({color:0xD4C4A0,roughness:.65});

  function cbox(geo,mat,px,py,pz){
    const m=new THREE.Mesh(geo,mat);
    m.position.set(px,py,pz);
    m.castShadow=true; m.receiveShadow=true; m.userData.deco=true; scene.add(m); return m;
  }

  // Floor slab
  cbox(new THREE.BoxGeometry(W+WT*2,8,D+WT*2),fMat, 0,-3.5,0);
  cbox(new THREE.BoxGeometry(W-.5,.15,D-.5),new THREE.MeshStandardMaterial({color:0xDDD0B0,roughness:.6}), 0,.07,0);

  // 4 walls
  cbox(new THREE.BoxGeometry(W+WT*2,H,WT),wMat, 0,H/2,-D/2-WT/2); // back
  for(let ix=-W/2-WT;ix<=W/2+WT;ix+=2.5) obstacles.push({x:ix,z:-D/2-WT/2,radius:WT+.9});
  cbox(new THREE.BoxGeometry(W+WT*2,H,WT),wMat, 0,H/2,D/2+WT/2); // front
  for(let ix=-W/2-WT;ix<=W/2+WT;ix+=2.5) obstacles.push({x:ix,z:D/2+WT/2,radius:WT+.9});
  cbox(new THREE.BoxGeometry(WT,H,D+WT*2),wMat, -W/2-WT/2,H/2,0); // left
  for(let iz=-D/2-WT;iz<=D/2+WT;iz+=2.5) obstacles.push({x:-W/2-WT/2,z:iz,radius:WT+.9});
  cbox(new THREE.BoxGeometry(WT,H,D+WT*2),wMat, W/2+WT/2,H/2,0); // right
  for(let iz=-D/2-WT;iz<=D/2+WT;iz+=2.5) obstacles.push({x:W/2+WT/2,z:iz,radius:WT+.9});

  // Ceiling ‚Äî note: lower than player spawn so spawn needs to be inside
  cbox(new THREE.BoxGeometry(W+WT*2,.3,D+WT*2),new THREE.MeshStandardMaterial({color:0xF5F5F0,roughness:.9}), 0,H+.15,0);

  // Blackboard
  cbox(new THREE.BoxGeometry(32,6,.6),new THREE.MeshStandardMaterial({color:0x1B5E30,roughness:.75}), 0,5,-D/2+WT*.4);
  cbox(new THREE.BoxGeometry(33,6.6,.3),new THREE.MeshStandardMaterial({color:0x8B6535,roughness:.85}), 0,5,-D/2+WT*.1);
  for(let i=0;i<4;i++){
    cbox(new THREE.BoxGeometry(6+Math.random()*3,.15,.1),
      new THREE.MeshStandardMaterial({color:0xF5F5F5,emissive:0xEEEEEE,emissiveIntensity:.12}),
      -12+i*8, 4.5+Math.random()*2, -D/2+WT*.5);
  }

  // Desks
  for(let row=0;row<4;row++) for(let col=0;col<4;col++) addDesk(-24+col*16,-20+row*12);
  addDesk(0,-D/2+8,true); // teacher desk

  // Bookshelves
  [-37,37].forEach(sx=>{
    cbox(new THREE.BoxGeometry(WT+.5,7,D*.65),new THREE.MeshStandardMaterial({color:0x8B6535,roughness:.9}), sx,3.5,2);
    for(let sz=-D*.32;sz<=D*.32;sz+=2.5) obstacles.push({x:sx,z:2+sz,radius:WT+1.0});
    const bookCols=[0xCC2222,0x2255CC,0x22AA44,0xCC8822,0x884499,0x226688,0xAA3355,0x558833];
    for(let b=0;b<12;b++){
      cbox(new THREE.BoxGeometry(.35,1.3+Math.random()*.3,.65),
        new THREE.MeshStandardMaterial({color:bookCols[b%8],roughness:.85}),
        sx+(sx>0?-.5:.5), .7+b*.55, -18+b*3);
    }
  });

  // Ceiling lights
  for(let i=0;i<3;i++){
    const bx=-20+i*20;
    cbox(new THREE.BoxGeometry(10,.2,.4),new THREE.MeshStandardMaterial({color:0xEEEECC,emissive:0xDDDDAA,emissiveIntensity:1.1}), bx,H-.15,0);
    const pl=new THREE.PointLight(0xFFF8EE,2.0,28);
    pl.position.set(bx,H-1,0); pl.userData.deco=true; pl.castShadow=false; scene.add(pl);
  }

  // Windows
  const winMat2=new THREE.MeshStandardMaterial({color:0x88CCFF,transparent:true,opacity:.5,roughness:.05});
  [-18,0,18].forEach(wz=>{
    cbox(new THREE.BoxGeometry(WT+.1,3.5,4.5),winMat2, W/2+WT/2,5.5,wz);
    cbox(new THREE.BoxGeometry(WT+.5,4,5),new THREE.MeshStandardMaterial({color:0xDDDDDD,roughness:.8}), W/2+WT/2,5.5,wz);
  });

  // Globe
  cbox(new THREE.BoxGeometry(.2,2.5,.2),new THREE.MeshStandardMaterial({color:0x888888}), 8,1.5,-D/2+10);
  cbox(new THREE.SphereGeometry(1.4,8,6),new THREE.MeshStandardMaterial({color:0x3388EE,roughness:.35}), 8,3.8,-D/2+10);

  // ‚îÄ‚îÄ SPAWN TINY ‚Äî FIXED ‚îÄ‚îÄ
  // Tiny is always visible (not hidden behind furniture), just in a corner of the room
  // Made bigger (1.8 size) so easier to spot, glowing outline added
  // Spots: middle aisle, near teacher desk, near window, near door, center
  const TINY_SPOTS=[
    [0, 0],           // center of room ‚Äî easy to find
    [0, -D/2+12],     // near blackboard
    [20, 10],         // right side middle
    [-20, 10],        // left side middle
    [0, D/2-10]       // near front
  ];
  const spot=TINY_SPOTS[Math.floor(Math.random()*TINY_SPOTS.length)];

  const tinyMat=new THREE.MeshStandardMaterial({
    color:typeCol('tiny'),side:THREE.DoubleSide,transparent:true,alphaTest:.05,
    emissive:0xFFD166, emissiveIntensity:0.35 // glow to make Tiny easier to spot
  });
  tLoader.load('tiny.png',tex=>{
    tinyMat.map=tex; tinyMat.color.set(0xFFFFFF);
    tinyMat.emissive.set(0x000000); tinyMat.emissiveIntensity=0;
    tinyMat.needsUpdate=true;
  },null,()=>{});

  // Tiny is bigger (1.8 instead of 1.0) ‚Äî easier to find
  const tinyMesh=new THREE.Mesh(new THREE.PlaneGeometry(1.8, 2.3), tinyMat);
  tinyMesh.position.set(spot[0], 1.3, spot[1]); // on the floor
  tinyMesh.castShadow=true; scene.add(tinyMesh);
  familyMeshes.push({mesh:tinyMesh, type:'tiny'});

  // Add a pulsing point light near Tiny so player can spot them
  const tinyLight = new THREE.PointLight(0xFFD166, 1.5, 12);
  tinyLight.position.set(spot[0], 2.5, spot[1]);
  tinyLight.userData.deco=true;
  tinyLight.userData.isTinyLight=true;
  scene.add(tinyLight);
}

function addDesk(x,z,big=false){
  const s=big?1.6:1;
  const deskH = 1.6; // desk top height
  const legH = 1.55;
  const desk=mkMesh(new THREE.BoxGeometry(7*s,.25,4*s),{color:0xc8a060,roughness:.8});
  desk.position.set(x,deskH,z); desk.castShadow=desk.receiveShadow=true; desk.userData.deco=true; scene.add(desk);
  [[-2.8,-.8],[2.8,-.8],[-2.8,1.5],[2.8,1.5]].forEach(([ox,oz])=>{
    const leg=mkMesh(new THREE.CylinderGeometry(.15,.15,legH,4),{color:0x7a5020});
    leg.position.set(x+ox*s,legH/2,z+oz*s); leg.userData.deco=true; scene.add(leg);
  });
  if(!big){ const paper=mkMesh(new THREE.BoxGeometry(2,.03,2.5),{color:0xfafafa,roughness:.9}); paper.position.set(x,deskH+.14,z); paper.userData.deco=true; scene.add(paper); }

  // FIX: Desk collision only when standing (player can crouch under)
  obstacles.push({mesh:desk, radius:big?5.5:3.2, x, z, requiresStanding:true});

  // Register as crouch-under zone
  underFurniture.push({x, z, radius:big?5.0:3.0, clearanceY:deskH-0.15, topY:deskH});
}

function spawnGrass(count,spread){
  const gm=new THREE.MeshStandardMaterial({color:0x2a8a22,side:THREE.DoubleSide,transparent:true,alphaTest:.1});
  for(let i=0;i<count;i++){
    const g=new THREE.Mesh(new THREE.PlaneGeometry(1.5+Math.random(),3+Math.random()*2),gm);
    const gx=(Math.random()-.5)*spread,gz=(Math.random()-.5)*spread;
    g.position.set(gx,terrainH(gx,gz)+1.5+Math.random(),gz); g.rotation.y=Math.random()*Math.PI;
    g.castShadow=false; scene.add(g); grassBlades.push(g);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONTROLS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const moveK={w:false,a:false,s:false,d:false};
const camK={ArrowLeft:false,ArrowRight:false,ArrowUp:false,ArrowDown:false};

window.addEventListener('keydown',e=>{
  const k=e.key;
  if(k in moveK) moveK[k]=true;
  if(k in camK){ camK[k]=true; e.preventDefault(); }
  if(k===' ') doJump();
  if(k==='c'||k==='C'){ isCrouching=true; }
  if((k==='f'||k==='F')&&accessMode==='dev'){ flyMode=!flyMode; showToast(flyMode?'Fly ON ‚Äî jump=rise':'Fly OFF'); }
  if((k==='r'||k==='R')&&accessMode==='dev'){ player.position.set(0,20,0); showToast('Position reset'); }
  if((k==='g'||k==='G')&&accessMode!=='normal') adminCollect();
});
window.addEventListener('keyup',e=>{ const k=e.key; if(k in moveK)moveK[k]=false; if(k in camK)camK[k]=false; if(k==='c'||k==='C') isCrouching=false; });

let joyX=0,joyY=0,joyActive=false,joyC={x:0,y:0};
const GRAVITY=.024,JUMP_V=.55,SPEED=.38;

const joyOuter=document.getElementById('joy-outer');
const joyInner=document.getElementById('joy-inner');
joyOuter.addEventListener('touchstart',e=>{ joyActive=true; const r=joyOuter.getBoundingClientRect(); joyC={x:r.left+65,y:r.top+65}; joyMove(e.touches[0]); },{passive:true});
joyOuter.addEventListener('touchmove',e=>{ if(joyActive){e.preventDefault();joyMove(e.touches[0]);} },{passive:false});
joyOuter.addEventListener('touchend',()=>{ joyActive=false; joyX=joyY=0; joyInner.style.transform='translate(0,0)'; });
function joyMove(t){
  let dx=t.clientX-joyC.x,dy=t.clientY-joyC.y;
  const d=Math.sqrt(dx*dx+dy*dy),m=42;
  if(d>m){dx=dx/d*m;dy=dy/d*m;}
  joyInner.style.transform=`translate(${dx}px,${dy}px)`;
  joyX=dx/m; joyY=dy/m;
}
document.getElementById('jump-btn').addEventListener('touchstart',e=>{e.preventDefault();doJump();});
const crouchBtn=document.getElementById('crouch-btn');
crouchBtn.addEventListener('touchstart',e=>{e.preventDefault();isCrouching=true;});
crouchBtn.addEventListener('touchend',e=>{e.preventDefault();isCrouching=false;});
function doJump(){ if(flyMode){flyVelY=.6;return;} if(isGrounded){velocityY=JUMP_V;isGrounded=false;} }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateHUD(){
  document.getElementById('c-dad').textContent=`Dad ${famFound.dad}/${famTargets.dad}`;
  document.getElementById('c-mum').textContent=`Mum ${famFound.mum}/${famTargets.mum}`;
  document.getElementById('c-bro').textContent=`Bros ${famFound.brother}/${famTargets.brother}`;
  document.getElementById('c-sis').textContent=`Sis ${famFound.sister}/${famTargets.sister}`;
  document.getElementById('c-tiny').textContent=`Tiny ${famFound.tiny}/${famTargets.tiny}`;
  const nt=famFound.dad+famFound.mum+famFound.brother+famFound.sister;
  const tot=famTargets.dad+famTargets.mum+famTargets.brother+famTargets.sister;
  if(nt>=tot){ const o=document.querySelector('#map-sel option[value="3"]'); if(o&&o.textContent.includes('üîí')) o.textContent="üè´ Map 3 ‚Äî Tiny's Hideout"; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COLLECTION & UNLOCK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkGroupUnlock(type){
  if(groupUnlocked[type]) return;
  if(famFound[type]>=famTargets[type]){
    groupUnlocked[type]=true;
    if(!unlockedSkins.includes(type)){
      unlockedSkins.push(type);
      saveUnlocked();
      buildSkinSel();
      buildSpritePicker();
      showUnlockBanner(type);
    }
  }
}
function checkWin(){
  if(famFound.dad+famFound.mum+famFound.brother+famFound.sister+famFound.tiny>=20){
    setTimeout(()=>alert(`üéâ You found the WHOLE family!\n${document.getElementById('timer-tag').textContent}\nAmazing work!`),400);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MAP GATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function tryMap(v){
  v=parseInt(v);
  if(v===3&&accessMode==='normal'){
    const nf=famFound.dad+famFound.mum+famFound.brother+famFound.sister;
    const nt=famTargets.dad+famTargets.mum+famTargets.brother+famTargets.sister;
    if(nf<nt){ showLocked("Find all of Dad, Mum, Brothers & Sisters first!\n(Across Maps 1 & 2)\nThen Tiny's Hideout unlocks üîí"); document.getElementById('map-sel').value=currentMap; return; }
  }
  currentMap=v; loadMap(v);
}

// Door proximity hint timer
let doorHintTimer=null;
function showDoorHint(){
  const el=document.getElementById('door-hint');
  el.style.display='block';
  clearTimeout(doorHintTimer);
  doorHintTimer=setTimeout(()=>el.style.display='none',2500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MAIN LOOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let lastT=0, frameCount=0;
function animate(ts=0){
  frameCount++;
  requestAnimationFrame(animate);
  const dt=Math.min((ts-lastT)/1000,.05); lastT=ts;

  // Day/Night cycle
  dayT+=DAY_SPEED;
  const sinT=Math.sin(dayT), cosT=Math.cos(dayT);
  const sunH=Math.max(0,sinT);
  if(Math.abs(sunH-lastSunH)>.002){ updateSky(sunH,sinT); lastSunH=sunH; }
  skyMesh.position.copy(camera.position);
  sun.position.set(cosT*300,sinT*300,80);
  sun.intensity=sunH*2.2+.05;
  if(sunH>0.01) sun.color.setHSL(0.10-sunH*0.05,1.0,Math.max(0.45,0.55+sunH*0.1));
  else sun.color.setHSL(0.62,0.4,0.15);

  const nightBlue=new THREE.Color(0x050520);
  const dawnOrange=new THREE.Color(0xff6600);
  const dayBlue=new THREE.Color(currentMap===2?0x55aaff:0x4499ee);
  const horizCol = sunH>0.01 ? new THREE.Color(0xff7700).lerp(new THREE.Color(0xbbddff),Math.min(1,sunH*2)) : new THREE.Color(0x1a0808);
  scene.fog.color.copy(horizCol);
  if(currentMap!==3) scene.fog.density=Math.max(.001,.0017-sunH*.0006);

  ambient.intensity=Math.max(.05,sunH*.3);
  hemiLight.intensity=Math.max(.1,sunH*1.1);
  fillLight.intensity=Math.max(0,.4-sunH*.5);
  fillLight.color.set(sunH<.1?0x8899ff:0x4488ff);

  // Tiny light pulse
  scene.children.filter(c=>c.userData.isTinyLight).forEach(l=>{
    l.intensity=1.2+Math.sin(ts*.003)*0.6;
  });

  // Camera keys
  if(camK.ArrowLeft)  camYaw  +=CAM_SPD;
  if(camK.ArrowRight) camYaw  -=CAM_SPD;
  if(camK.ArrowUp)    camPitch =clamp(camPitch+CAM_SPD,.05,1.45);
  if(camK.ArrowDown)  camPitch =clamp(camPitch-CAM_SPD,.05,1.45);

  // Movement
  let mx=0,mz=0;
  const fwd=new THREE.Vector3(-Math.sin(camYaw),0,-Math.cos(camYaw));
  const rgt=new THREE.Vector3( Math.cos(camYaw),0,-Math.sin(camYaw));
  if(joyActive){
    mx=-fwd.x*joyY*SPEED+rgt.x*joyX*SPEED;
    mz=-fwd.z*joyY*SPEED+rgt.z*joyX*SPEED;
  } else {
    if(moveK.w){mx+=fwd.x*SPEED;mz+=fwd.z*SPEED;}
    if(moveK.s){mx-=fwd.x*SPEED;mz-=fwd.z*SPEED;}
    if(moveK.a){mx-=rgt.x*SPEED;mz-=rgt.z*SPEED;}
    if(moveK.d){mx+=rgt.x*SPEED;mz+=rgt.z*SPEED;}
  }

  const nx=player.position.x+mx, nz=player.position.z+mz;

  // ‚îÄ‚îÄ COLLISION RESOLUTION ‚îÄ‚îÄ
  // Determine player effective height for crouch
  const playerH = isCrouching ? 0.6 : 1.2; // crouching = low profile

  let hitX=false, hitZ=false;
  if(!(accessMode==='dev'&&flyMode)){
    const px2=player.position.x, pz2=player.position.z;

    for(const r of obstacles){
      // Skip furniture when crouching (player slides under desks/beds)
      if(r.requiresStanding && isCrouching) continue;

      // Door wall: check if player is passing through the door gap
      if(r.isDoorWall){
        // Find which house this door belongs to
        let inDoorGap=false;
        for(const h of housePositions){
          // The door gap is at x: [h.doorX - h.doorW/2, h.doorX + h.doorW/2]
          const onFrontWall = Math.abs(nz - h.doorZ) < 1.5 || Math.abs(r.z - h.doorZ) < 1.5;
          if(onFrontWall){
            const inGap = Math.abs(nx - h.doorX) < h.doorW/2;
            if(inGap){ inDoorGap=true; break; }
          }
        }
        if(inDoorGap) continue; // allow through door
      }

      const rr=r.radius+1.0;
      const rdxN=Math.abs(nx-r.x), rdzN=Math.abs(nz-r.z);
      const rdxO=Math.abs(px2-r.x), rdzO=Math.abs(pz2-r.z);
      if(rdxN*rdxN+rdzN*rdzN<rr*rr){
        // Try sliding along X
        if(rdxO*rdxO+rdzN*rdzN>=rr*rr){ hitX=true; }
        // Try sliding along Z
        else if(rdxN*rdxN+rdzO*rdzO>=rr*rr){ hitZ=true; }
        else { hitX=true; hitZ=true; }
      }
    }
  }

  if(!hitX) player.position.x=nx;
  if(!hitZ) player.position.z=nz;

  // Door proximity hint for map 1
  if(currentMap===1 && (mx!==0||mz!==0)){
    for(const h of housePositions){
      const dx=player.position.x-h.x, dz=player.position.z-h.z;
      const nearFront=Math.abs(dz-(h.z+h.d/2))<3 && Math.abs(dx)<h.w/2;
      if(nearFront && !(Math.abs(dx)<h.doorW/2+0.5)){
        showDoorHint(); break;
      }
    }
  }

  // ‚îÄ‚îÄ CROUCHING PHYSICS ‚îÄ‚îÄ
  // When crouching, player mesh shrinks and Y offset lowers
  const tH=terrainH(player.position.x,player.position.z);
  const crouchYOffset = isCrouching ? 0.5 : 1.2; // lower Y when crouching
  const groundY = tH + crouchYOffset;

  if(flyMode){
    flyVelY*=.9; player.position.y+=flyVelY;
    if(player.position.y<groundY) player.position.y=groundY;
    isGrounded=false;
  } else {
    if(!isGrounded){ player.position.y+=velocityY; velocityY-=GRAVITY; if(player.position.y<=groundY){player.position.y=groundY;isGrounded=true;velocityY=0;} }
    else{ player.position.y=groundY; }
  }

  // Player mesh scale for crouching (squish down)
  player.scale.y = isCrouching ? 0.55 : 1.0;

  disc.position.set(player.position.x,tH+.04,player.position.z);

  // Billboards
  const cfx=camera.position.x,cfz=camera.position.z;
  player.lookAt(cfx,player.position.y,cfz);
  familyMeshes.forEach(f=>f.mesh.lookAt(cfx,f.mesh.position.y,cfz));
  for(const id in peers) peers[id].mesh.lookAt(cfx,peers[id].mesh.position.y,cfz);

  // Grass sway
  const t2=ts*.001;
  grassBlades.forEach((g,i)=>{ g.rotation.z=Math.sin(t2*1.4+i*.7)*.09; });

  doUpdateCamera();
  label3D(player,document.getElementById('name-label'));
  for(const id in peers) label3D(peers[id].mesh,peers[id].labelDiv);

  // Collection
  const collectR=2.6;
  for(let i=familyMeshes.length-1;i>=0;i--){
    const f=familyMeshes[i];
    if(player.position.distanceTo(f.mesh.position)<collectR){
      scene.remove(f.mesh);
      // Remove tiny's light too
      if(f.type==='tiny'){
        const tl=scene.children.find(c=>c.userData.isTinyLight);
        if(tl) scene.remove(tl);
      }
      famFound[f.type]++; familyMeshes.splice(i,1);
      updateHUD(); checkGroupUnlock(f.type); checkWin();
    }
  }

  // Net sync
  for(const id in peers){ const p=peers[id]; if(p.conn&&p.conn.open) p.conn.send({type:'move',x:player.position.x,y:player.position.y,z:player.position.z}); }

  // Dev panel
  if(accessMode==='dev'){
    const pp=player.position;
    document.getElementById('dev-panel').textContent=
      `POS(${pp.x.toFixed(0)},${pp.y.toFixed(0)},${pp.z.toFixed(0)}) CAM yaw:${(camYaw*57.3).toFixed(0)}¬∞ pitch:${(camPitch*57.3).toFixed(0)}¬∞\n`+
      `Family left:${familyMeshes.length}  Map:${currentMap}  Fly:${flyMode?'ON':'OFF'}  Skin:${currentSkin}\n`+
      `[F]fly [R]reset [G]collect [‚Üê‚Üí‚Üë‚Üì]camera`;
  }

  renderer.render(scene,camera);
}

function label3D(mesh,el){
  const v=mesh.position.clone(); v.y+=2; v.project(camera);
  if(v.z>1){el.style.display='none';return;}
  el.style.left=`${(v.x*.5+.5)*innerWidth}px`; el.style.top=`${(v.y*-.5+.5)*innerHeight}px`; el.style.display='block';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UI HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showLocked(t){ const el=document.getElementById('locked-msg'); el.innerHTML='üîí '+t.replace(/\n/g,'<br>'); el.style.display='block'; clearTimeout(el._t); el._t=setTimeout(()=>el.style.display='none',3500); }
function showUnlockBanner(type){
  const el=document.getElementById('unlock-banner'); const src=SKIN_IMGS[type]||'';
  el.innerHTML=`<div style="font-size:2.2rem">üéâ Group Found!</div>${src?`<img src="${src}" onerror="this.style.display='none'" style="object-fit:cover">`:''}  <div style="font-size:1.1rem">All <b>${type}s</b> found!<br><span style="font-size:.85rem;opacity:.8">New skin unlocked!</span></div>`;
  el.style.display='block'; clearTimeout(el._t); el._t=setTimeout(()=>el.style.display='none',4000);
}
function showToast(msg,dur=2800){ const el=document.getElementById('toast'); el.textContent=msg; el.style.display='block'; clearTimeout(el._t); el._t=setTimeout(()=>el.style.display='none',dur); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TIMER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startTimer(){ if(timerInterval)clearInterval(timerInterval); secondsElapsed=0; timerInterval=setInterval(()=>{ secondsElapsed++; const m=Math.floor(secondsElapsed/60).toString().padStart(2,'0'),s=(secondsElapsed%60).toString().padStart(2,'0'); document.getElementById('timer-tag').textContent=m+':'+s; },1000); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  START GAME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startGame(){
  playerName=document.getElementById('inp-name').value.trim()||'Explorer';
  const nameLabel=document.getElementById('name-label');
  nameLabel.innerText=playerName;
  if(accessMode==='admin') nameLabel.classList.add('fname-admin');
  if(accessMode==='dev')   nameLabel.classList.add('fname-dev');

  updateModeTag();
  initNet(document.getElementById('inp-room').value.trim());

  document.getElementById('menu').style.opacity='0';
  setTimeout(()=>{
    document.getElementById('menu').style.display='none';
    document.getElementById('hud').style.display='block';
    document.getElementById('top-right').style.display='flex';
    document.getElementById('name-label').style.display='block';
    document.getElementById('joy-wrap').style.display='block';
    document.getElementById('jump-btn').style.display='block';
    document.getElementById('crouch-btn').style.display='block';
    document.getElementById('cam-hint').style.display='block';
    document.getElementById('skin-sel').style.display='flex';
    document.getElementById('dialogue').style.display='flex';

    const dImg = document.getElementById('d-img');
    dImg.src = currentSkin + '.png';
    dImg.onerror = function(){ this.onerror=null; this.style.visibility='hidden'; };
    document.querySelector('#dialogue .d-name').textContent = (currentSkin[0].toUpperCase()+currentSkin.slice(1)) + ' üê¢';

    currentSkin=unlockedSkins.includes(chosenSprite)?chosenSprite:'friend';
    currentMap=1; loadMap(1);
    buildSkinSel(); applySkin(currentSkin);
    startTimer(); gameStarted=true; animate();

    setTimeout(()=>document.getElementById('cam-hint').style.display='none',8000);
  },600);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function clamp(v,mn,mx){ return Math.max(mn,Math.min(mx,v)); }

window.addEventListener('resize',()=>{ camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth,innerHeight); });
</script>
</body>
</html>
