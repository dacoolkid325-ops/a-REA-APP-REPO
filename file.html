<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MASTER - The Game</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Roboto:wght@400;700&display=swap');

        :root {
            --primary: #ff4757;
            --secondary: #2f3542;
            --accent: #ffa502;
            --floor: #eccc68;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #222;
            font-family: 'Roboto', sans-serif;
            touch-action: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: #333;
        }

        canvas { display: block; }

        .ui-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        #hud {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            color: white;
            font-family: 'Black Ops One', cursive;
            font-size: 1.2rem;
            text-shadow: 2px 2px 0 #000;
        }

        .hud-panel {
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: white;
            pointer-events: auto;
        }

        .hidden { display: none !important; }

        .title-logo {
            max-width: 80%;
            height: auto;
            max-height: 200px;
            margin-bottom: 20px;
            filter: drop-shadow(0 0 10px rgba(255, 71, 87, 0.5));
        }
        
        .skin-row { display: flex; gap: 15px; margin: 20px 0; flex-wrap: wrap; justify-content: center;}
        .skin-item { 
            width: 45px; height: 45px; border-radius: 50%; border: 3px solid #555; cursor: pointer;
            position: relative;
            transition: transform 0.2s;
        }
        .skin-item.selected { border-color: white; transform: scale(1.1); box-shadow: 0 0 15px var(--primary); }
        .skin-item.locked { opacity: 0.5; }
        .skin-item.locked::after { content: 'üîí'; position: absolute; font-size: 14px; top: 10px; left: 12px; }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-family: 'Black Ops One', cursive;
            cursor: pointer;
            border-radius: 5px;
            margin: 10px;
            text-transform: uppercase;
        }

        /* Responsive Mobile Controls */
        #mobile-controls {
            position: absolute;
            bottom: 0; left: 0;
            width: 100%; height: 100%;
            display: none;
            pointer-events: none;
            z-index: 50;
        }

        .joystick-area {
            position: absolute; bottom: 50px; left: 50px;
            width: 120px; height: 120px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
            pointer-events: auto;
        }
        
        .joystick-knob {
            position: absolute; top: 50%; left: 50%;
            width: 50px; height: 50px;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        .btn-zone { 
            position: absolute; bottom: 50px; right: 50px; 
            display: flex; gap: 20px; pointer-events: auto; 
        }
        .m-btn { 
            width: 80px; height: 80px; border-radius: 50%; 
            background: rgba(255,255,255,0.15); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 30px; border: 3px solid rgba(255,255,255,0.4);
            user-select: none;
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    
    <div class="ui-layer">
        <div id="hud">
            <div class="hud-panel">TIMER: <span id="timer">05:00</span></div>
            <div class="hud-panel" id="status-box">STATUS: <span id="status">SURVIVE</span></div>
        </div>

        <div id="mobile-controls">
            <div id="joy-base" class="joystick-area">
                <div id="joy-knob" class="joystick-knob"></div>
            </div>
            <div class="btn-zone">
                <div id="m-block" class="m-btn">üõ°Ô∏è</div>
                <div id="m-fire" class="m-btn">üî•</div>
            </div>
        </div>
    </div>

    <div id="menu" class="screen">
        <img class="title-logo" src="https://i.ibb.co/DPM4fnPq/1787703-D-C243-4928-9-FFA-FF082-D63-D02-B.png" alt="MASTER LOGO">
        <div class="skin-row" id="skin-list"></div>
        <div>
            <button onclick="startGame('original')">ORIGINAL</button>
            <button onclick="startGame('modern')">MODERN</button>
        </div>
    </div>

    <div id="gameover" class="screen hidden">
        <h1 id="result-text">YOU WIN!</h1>
        <button onclick="location.reload()">REPLAY</button>
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

function lerpAngle(start, end, amt) {
    let cs = (1 - amt) * Math.cos(start) + amt * Math.cos(end);
    let sn = (1 - amt) * Math.sin(start) + amt * Math.sin(end);
    return Math.atan2(sn, cs);
}

const SKINS = [
    { name: 'Default', color: '#ffffff', wins: 0 },
    { name: 'Blue', color: '#1e90ff', wins: 1 },
    { name: 'Green', color: '#2ed573', wins: 2 },
    { name: 'Gold', color: '#ffa502', wins: 4 },
    { name: 'Void', color: '#70a1ff', wins: 6 }
];

let gameState = {
    mode: 'original',
    timer: 300,
    players: [],
    projectiles: [],
    particles: [],
    wins: parseInt(localStorage.getItem('masterWins') || '0'),
    selectedSkin: 0,
    isMobile: 'ontouchstart' in window || navigator.maxTouchPoints > 0,
    running: false
};

const skinList = document.getElementById('skin-list');
SKINS.forEach((s, i) => {
    const div = document.createElement('div');
    div.className = `skin-item ${gameState.wins < s.wins ? 'locked' : ''} ${i === 0 ? 'selected' : ''}`;
    div.style.background = s.color;
    div.onclick = () => {
        if(gameState.wins >= s.wins) {
            document.querySelectorAll('.skin-item').forEach(el => el.classList.remove('selected'));
            div.classList.add('selected');
            gameState.selectedSkin = i;
        }
    };
    skinList.appendChild(div);
});

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.onresize = resize;
resize();

const keys = {};
const mouse = { x: 0, y: 0, pressed: false };
const joy = { active: false, x: 0, y: 0, touchId: null };

window.onkeydown = (e) => keys[e.code] = true;
window.onkeyup = (e) => keys[e.code] = false;
window.onmousemove = (e) => { mouse.x = e.clientX; mouse.y = e.clientY; };
window.onmousedown = () => mouse.pressed = true;
window.onmouseup = () => mouse.pressed = false;

const joyBase = document.getElementById('joy-base');
const joyKnob = document.getElementById('joy-knob');
const joyRadius = 60;

joyBase.addEventListener('touchstart', (e) => {
    e.preventDefault();
    const touch = e.changedTouches[0];
    joy.active = true;
    joy.touchId = touch.identifier;
    handleJoy(touch);
}, {passive: false});

window.addEventListener('touchmove', (e) => {
    for (let t of e.changedTouches) {
        if (t.identifier === joy.touchId) handleJoy(t);
    }
}, {passive: false});

window.addEventListener('touchend', (e) => {
    for (let t of e.changedTouches) {
        if (t.identifier === joy.touchId) {
            joy.active = false;
            joy.touchId = null;
            joy.x = 0; joy.y = 0;
            joyKnob.style.transform = `translate(-50%, -50%)`;
        }
    }
});

function handleJoy(touch) {
    const rect = joyBase.getBoundingClientRect();
    const centerX = rect.left + rect.width/2;
    const centerY = rect.top + rect.height/2;
    let dx = touch.clientX - centerX;
    let dy = touch.clientY - centerY;
    const dist = Math.hypot(dx, dy);
    
    if (dist > joyRadius) {
        dx = (dx / dist) * joyRadius;
        dy = (dy / dist) * joyRadius;
    }
    
    joy.x = dx / joyRadius;
    joy.y = dy / joyRadius;
    joyKnob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
}

let mobileFire = false;
let mobileBlock = false;
document.getElementById('m-fire').addEventListener('touchstart', (e) => { e.preventDefault(); mobileFire = true; });
document.getElementById('m-fire').addEventListener('touchend', () => mobileFire = false);
document.getElementById('m-block').addEventListener('touchstart', (e) => { e.preventDefault(); mobileBlock = true; });
document.getElementById('m-block').addEventListener('touchend', () => mobileBlock = false);

class Particle {
    constructor(x, y, color) {
        this.x = x; this.y = y;
        this.color = color;
        const a = Math.random() * Math.PI * 2;
        const s = Math.random() * 3 + 1;
        this.vx = Math.cos(a) * s;
        this.vy = Math.sin(a) * s;
        this.life = 1.0;
        this.decay = 0.04;
    }
    update() {
        this.x += this.vx; this.y += this.vy;
        this.life -= this.decay;
    }
    draw() {
        ctx.globalAlpha = this.life;
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(this.x, this.y, 3, 0, Math.PI*2);
        ctx.fill();
        ctx.globalAlpha = 1;
    }
}

class Player {
    constructor(x, y, isBot, color) {
        this.x = x; this.y = y;
        this.isBot = isBot;
        this.color = color;
        this.radius = 22;
        this.isMaster = false;
        this.speed = isBot ? 3.3 : 4;
        this.cooldown = 0;
        this.isBlocking = false;
        this.angle = 0;
        this.targetAngle = 0;
        this.immunityTimer = 0;
        this.wanderTime = 0;
    }

    update() {
        if(this.cooldown > 0) this.cooldown--;
        if(this.immunityTimer > 0) this.immunityTimer--;

        let moveX = 0; let moveY = 0;

        if(!this.isBot) {
            if(keys['KeyW']) moveY = -1;
            if(keys['KeyS']) moveY = 1;
            if(keys['KeyA']) moveX = -1;
            if(keys['KeyD']) moveX = 1;
            if(joy.active) { moveX = joy.x; moveY = joy.y; }

            this.isBlocking = (gameState.mode === 'modern' && !this.isMaster && (keys['Space'] || mobileBlock));
            
            if(this.isMaster && (mouse.pressed || mobileFire) && this.cooldown <= 0) this.shoot();
            
            if(gameState.isMobile) {
                if(Math.hypot(moveX, moveY) > 0.1) this.angle = Math.atan2(moveY, moveX);
            } else {
                this.angle = Math.atan2(mouse.y - this.y, mouse.x - this.x);
            }
        } else {
            // Updated NPC AI - Avoid Corners
            const master = gameState.players.find(p => p.isMaster);
            let avoidX = 0; let avoidY = 0;
            const margin = 100;
            if(this.x < margin) avoidX = 1;
            if(this.x > canvas.width - margin) avoidX = -1;
            if(this.y < margin) avoidY = 1;
            if(this.y > canvas.height - margin) avoidY = -1;

            if(this.isMaster) {
                let target = gameState.players.find(p => !p.isMaster);
                this.targetAngle = Math.atan2(target.y - this.y, target.x - this.x);
                moveX = Math.cos(this.targetAngle); moveY = Math.sin(this.targetAngle);
                if(Math.hypot(target.x - this.x, target.y - this.y) < 300 && this.cooldown <= 0) this.shoot();
            } else {
                const dist = Math.hypot(this.x - master.x, this.y - master.y);
                if(dist < 300) {
                    this.targetAngle = Math.atan2(this.y - master.y, this.x - master.x);
                    moveX = Math.cos(this.targetAngle) + avoidX*1.5;
                    moveY = Math.sin(this.targetAngle) + avoidY*1.5;
                    if(gameState.mode === 'modern') this.isBlocking = Math.random() > 0.98;
                } else {
                    this.wanderTime--;
                    if(this.wanderTime <= 0) {
                        this.targetAngle = Math.random() * Math.PI * 2;
                        this.wanderTime = 60 + Math.random() * 60;
                    }
                    moveX = Math.cos(this.targetAngle) + avoidX;
                    moveY = Math.sin(this.targetAngle) + avoidY;
                    this.isBlocking = false;
                }
            }
            this.angle = lerpAngle(this.angle, this.targetAngle, 0.1);
        }

        const s = this.isBlocking ? this.speed * 0.4 : this.speed;
        this.x += moveX * s;
        this.y += moveY * s;

        // Hard Boundaries
        this.x = Math.max(this.radius, Math.min(canvas.width - this.radius, this.x));
        this.y = Math.max(this.radius, Math.min(canvas.height - this.radius, this.y));
    }

    shoot() {
        gameState.projectiles.push({
            x: this.x + Math.cos(this.angle) * 30,
            y: this.y + Math.sin(this.angle) * 30,
            vx: Math.cos(this.angle) * 12,
            vy: Math.sin(this.angle) * 12,
            owner: this
        });
        this.cooldown = 40;
    }

    draw() {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angle);
        
        if(this.isMaster) {
            ctx.beginPath();
            ctx.arc(0, 0, this.radius + 12, 0, Math.PI*2);
            ctx.strokeStyle = `rgba(255, 71, 87, ${0.5 + Math.sin(Date.now()/100)*0.2})`;
            ctx.lineWidth = 4;
            ctx.stroke();
        }

        if(this.isBlocking) {
            ctx.beginPath();
            ctx.arc(0, 0, this.radius + 10, -Math.PI/2, Math.PI/2);
            ctx.strokeStyle = '#3498db';
            ctx.lineWidth = 6;
            ctx.stroke();
        }

        ctx.beginPath();
        ctx.arc(0, 0, this.radius, 0, Math.PI*2);
        ctx.fillStyle = this.color;
        ctx.fill();
        ctx.strokeStyle = '#222';
        ctx.lineWidth = 3;
        ctx.stroke();

        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.arc(10, -8, 5, 0, Math.PI*2);
        ctx.arc(10, 8, 5, 0, Math.PI*2);
        ctx.fill();
        ctx.restore();
    }
}

function startGame(mode) {
    gameState.mode = mode;
    gameState.timer = 300;
    gameState.players = [new Player(canvas.width/2, canvas.height/2, false, SKINS[gameState.selectedSkin].color)];
    for(let i=0; i<6; i++) {
        gameState.players.push(new Player(Math.random()*canvas.width, Math.random()*canvas.height, true, '#95a5a6'));
    }
    const m = Math.floor(Math.random()*gameState.players.length);
    gameState.players[m].isMaster = true;
    gameState.players[m].immunityTimer = 50;

    document.getElementById('menu').classList.add('hidden');
    if(gameState.isMobile) document.getElementById('mobile-controls').style.display = 'block';
    gameState.running = true;
    requestAnimationFrame(gameLoop);
}

function spawnParticles(x, y, color) {
    for(let i=0; i<8; i++) gameState.particles.push(new Particle(x, y, color));
}

function gameLoop() {
    if(!gameState.running) return;
    if(gameState.timer <= 0) { endGame(); return; }

    ctx.fillStyle = '#eccc68';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.strokeStyle = 'rgba(0,0,0,0.05)';
    for(let i=0; i<canvas.width; i+=80) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,canvas.height); ctx.stroke(); }
    for(let i=0; i<canvas.height; i+=80) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(canvas.width,i); ctx.stroke(); }

    gameState.timer -= 1/60;
    document.getElementById('timer').innerText = new Date(gameState.timer * 1000).toISOString().substr(14, 5);
    
    const p1 = gameState.players[0];
    document.getElementById('status').innerText = p1.isMaster ? 'TAG OTHERS!' : 'RUN!';
    document.getElementById('status').style.color = p1.isMaster ? '#ff4757' : '#2ed573';

    gameState.players.forEach(p => { p.update(); p.draw(); });

    for(let i=gameState.particles.length-1; i>=0; i--) {
        gameState.particles[i].update();
        gameState.particles[i].draw();
        if(gameState.particles[i].life <= 0) gameState.particles.splice(i, 1);
    }

    for(let i=gameState.projectiles.length-1; i>=0; i--) {
        const p = gameState.projectiles[i];
        p.x += p.vx; p.y += p.vy;
        let hit = false;

        if(p.x < 0 || p.x > canvas.width || p.y < 0 || p.y > canvas.height) hit = true;

        if(!hit) {
            for(let pl of gameState.players) {
                if(pl === p.owner) continue;
                if(Math.hypot(pl.x - p.x, pl.y - p.y) < pl.radius + 12) {
                    if(pl.isBlocking) {
                        spawnParticles(p.x, p.y, '#3498db');
                        hit = true; break;
                    }
                    if(pl.immunityTimer <= 0) {
                        spawnParticles(pl.x, pl.y, '#ff4757');
                        gameState.players.forEach(x => x.isMaster = false);
                        pl.isMaster = true;
                        pl.immunityTimer = 50;
                        pl.isBlocking = false;
                        hit = true; break;
                    }
                }
            }
        }
        if(hit) gameState.projectiles.splice(i, 1);
        else {
            ctx.fillStyle = '#ff4757';
            ctx.beginPath(); ctx.arc(p.x, p.y, 10, 0, Math.PI*2); ctx.fill();
        }
    }
    requestAnimationFrame(gameLoop);
}

function endGame() {
    gameState.running = false;
    const win = !gameState.players[0].isMaster;
    if(win) {
        gameState.wins++;
        localStorage.setItem('masterWins', gameState.wins);
    }
    document.getElementById('gameover').classList.remove('hidden');
    document.getElementById('result-text').innerText = win ? 'VICTORY' : 'DEFEAT';
}
</script>
</body>
</html>